(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[180],{17722:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return r(71108)}])},83867:(e,t,r)=>{"use strict";r.d(t,{Q:()=>i,v:()=>c});var n=r(85893),s=r(67294),o=r(11163),a=r(31530),l=r(19182);let i=e=>{let t=t=>{let r=(0,o.useRouter)(),[a,i]=(0,s.useState)(!0);return((0,s.useEffect)(()=>{l.Z.getCurrentUser()?i(!1):r.replace("/?redirect="+r.asPath)},[r]),a)?null:(0,n.jsx)(e,{...t})},r=e.displayName||e.name||"Component";return t.displayName="WithAuth(".concat(r,")"),t},c=e=>{let t=t=>{let r=(0,o.useRouter)(),[i,c]=(0,s.useState)(!0);return((0,s.useEffect)(()=>{(async()=>{r.isReady&&(l.Z.getCurrentUser()&&"/"===r.pathname?await r.replace("/chat-rooms"):c(!1))})()},[r,r.isReady]),i)?(0,n.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",backgroundColor:"var(--vapor-color-background)",color:"var(--vapor-color-text-primary)"},children:(0,n.jsx)(a.x,{typography:"body1",children:"Loading..."})}):(0,n.jsx)(e,{...t})},r=e.displayName||e.name||"Component";return t.displayName="WithoutAuth(".concat(r,")"),t}},71108:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>ef});var n=r(85893),s=r(67294),o=r(83707),a=r(63171),l=r(74341),i=r(31530),c=r(1539),u=r(2026),d=r(74303),m=r(4987),g=r(22226),p=r(83867),h=r(11163),f=r(19182),v=r(37804),y=r(78536),x=r(29204),j=r(87066);class w{async validateFile(e){if(!e){let e="파일이 선택되지 않았습니다.";return y.F.error(e),{success:!1,message:e}}if(e.size>this.uploadLimit){let e="파일 크기는 ".concat(this.formatFileSize(this.uploadLimit),"를 초과할 수 없습니다.");return y.F.error(e),{success:!1,message:e}}let t=!1,r=0,n=null;for(let s of Object.values(this.allowedTypes))if(s.mimeTypes.includes(e.type)){t=!0,r=s.maxSize,n=s;break}if(!t){let e="지원하지 않는 파일 형식입니다.";return y.F.error(e),{success:!1,message:e}}if(e.size>r){let e="".concat(n.name," 파일은 ").concat(this.formatFileSize(r),"를 초과할 수 없습니다.");return y.F.error(e),{success:!1,message:e}}let s=this.getFileExtension(e.name);if(!n.extensions.includes(s.toLowerCase())){let e="파일 확장자가 올바르지 않습니다.";return y.F.error(e),{success:!1,message:e}}return{success:!0}}async uploadFile(e,t){var r,n;let s=await this.validateFile(e);if(!s.success)return s;try{let n=f.Z.getCurrentUser();if(!(null==n?void 0:n.token)||!(null==n?void 0:n.sessionId))return{success:!1,message:"인증 정보가 없습니다."};let s=new FormData;s.append("file",e);let o=x.$B.source();this.activeUploads.set(e.name,o);let a=this.baseUrl?"".concat(this.baseUrl,"/api/files/upload"):"/api/files/upload",l=await j.default.post(a,s,{headers:{"Content-Type":"multipart/form-data","x-auth-token":n.token,"x-session-id":n.sessionId},cancelToken:o.token,withCredentials:!0,onUploadProgress:e=>{if(t){let r=Math.round(100*e.loaded/e.total);t(r)}}});if(this.activeUploads.delete(e.name),!l.data||!l.data.success)return{success:!1,message:(null===(r=l.data)||void 0===r?void 0:r.message)||"파일 업로드에 실패했습니다."};let i=l.data.file;return{success:!0,data:{...l.data,file:{...i,url:this.getFileUrl(i.filename,!0)}}}}catch(r){if(this.activeUploads.delete(e.name),(0,x.Mw)(r))return{success:!1,message:"업로드가 취소되었습니다."};if((null===(n=r.response)||void 0===n?void 0:n.status)===401)try{if(await f.Z.refreshToken())return this.uploadFile(e,t);return{success:!1,message:"인증이 만료되었습니다. 다시 로그인해주세요."}}catch(e){return{success:!1,message:"인증이 만료되었습니다. 다시 로그인해주세요."}}return this.handleUploadError(r)}}async downloadFile(e,t){try{let r=f.Z.getCurrentUser();if(!(null==r?void 0:r.token)||!(null==r?void 0:r.sessionId))return{success:!1,message:"인증 정보가 없습니다."};let n=this.getFileUrl(e,!1),s=await j.default.head(n,{headers:{"x-auth-token":r.token,"x-session-id":r.sessionId},validateStatus:e=>e<500,withCredentials:!0});if(404===s.status)return{success:!1,message:"파일을 찾을 수 없습니다."};if(403===s.status)return{success:!1,message:"파일에 접근할 권한이 없습니다."};if(200!==s.status)return{success:!1,message:"파일 다운로드 준비 중 오류가 발생했습니다."};let o=await (0,j.default)({method:"GET",url:n,headers:{"x-auth-token":r.token,"x-session-id":r.sessionId},responseType:"blob",timeout:3e4,withCredentials:!0}),a=o.headers["content-type"],l=o.headers["content-disposition"],i=t;if(l){let e=l.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"|filename=([^;]+)/);e&&(i=decodeURIComponent(e[1]||e[2]||e[3]))}let c=new Blob([o.data],{type:a||"application/octet-stream"}),u=window.URL.createObjectURL(c),d=document.createElement("a");return d.href=u,d.download=i,d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),setTimeout(()=>{window.URL.revokeObjectURL(u)},100),{success:!0}}catch(n){var r;if((null===(r=n.response)||void 0===r?void 0:r.status)===401)try{if(await f.Z.refreshToken())return this.downloadFile(e,t)}catch(e){return{success:!1,message:"인증이 만료되었습니다. 다시 로그인해주세요."}}return this.handleDownloadError(n)}}getFileUrl(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e?"".concat("http://3.38.186.15:5001","/api/files/").concat(t?"view":"download","/").concat(e):""}getPreviewUrl(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!(null==e?void 0:e.filename))return"";let r="".concat("http://3.38.186.15:5001","/api/files/view/").concat(e.filename);if(!t)return r;let n=f.Z.getCurrentUser();if(!(null==n?void 0:n.token)||!(null==n?void 0:n.sessionId))return r;let s=new URL(r);return s.searchParams.append("token",encodeURIComponent(n.token)),s.searchParams.append("sessionId",encodeURIComponent(n.sessionId)),s.toString()}getFileType(e){if(!e)return"unknown";let t=this.getFileExtension(e).toLowerCase();for(let[e,r]of Object.entries(this.allowedTypes))if(r.extensions.includes(t))return e;return"unknown"}getFileExtension(e){if(!e)return"";let t=e.split(".");return t.length>1?".".concat(t.pop().toLowerCase()):""}formatFileSize(e){if(!e||0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return"".concat(parseFloat((e/Math.pow(1024,t)).toFixed(2))," ").concat(["B","KB","MB","GB","TB"][t])}getHeaders(){let e=f.Z.getCurrentUser();return(null==e?void 0:e.token)&&(null==e?void 0:e.sessionId)?{"x-auth-token":e.token,"x-session-id":e.sessionId,Accept:"application/json, */*"}:{}}handleUploadError(e){if(console.error("Upload error:",e),"ECONNABORTED"===e.code)return{success:!1,message:"파일 업로드 시간이 초과되었습니다."};if(j.default.isAxiosError(e)){var t,r,n;let s=null===(t=e.response)||void 0===t?void 0:t.status,o=null===(n=e.response)||void 0===n?void 0:null===(r=n.data)||void 0===r?void 0:r.message;switch(s){case 400:return{success:!1,message:o||"잘못된 요청입니다."};case 401:return{success:!1,message:"인증이 필요합니다."};case 413:return{success:!1,message:"파일이 너무 큽니다."};case 415:return{success:!1,message:"지원하지 않는 파일 형식입니다."};case 500:return{success:!1,message:"서버 오류가 발생했습니다."};default:return{success:!1,message:o||"파일 업로드에 실패했습니다."}}}return{success:!1,message:e.message||"알 수 없는 오류가 발생했습니다.",error:e}}handleDownloadError(e){if(console.error("Download error:",e),"ECONNABORTED"===e.code)return{success:!1,message:"파일 다운로드 시간이 초과되었습니다."};if(j.default.isAxiosError(e)){var t,r,n;let s=null===(t=e.response)||void 0===t?void 0:t.status,o=null===(n=e.response)||void 0===n?void 0:null===(r=n.data)||void 0===r?void 0:r.message;switch(s){case 404:return{success:!1,message:"파일을 찾을 수 없습니다."};case 403:return{success:!1,message:"파일에 접근할 권한이 없습니다."};case 400:return{success:!1,message:o||"잘못된 요청입니다."};case 500:return{success:!1,message:"서버 오류가 발생했습니다."};default:return{success:!1,message:o||"파일 다운로드에 실패했습니다."}}}return{success:!1,message:e.message||"알 수 없는 오류가 발생했습니다.",error:e}}cancelUpload(e){let t=this.activeUploads.get(e);return t?(t.cancel("Upload canceled by user"),this.activeUploads.delete(e),{success:!0,message:"업로드가 취소되었습니다."}):{success:!1,message:"취소할 업로드를 찾을 수 없습니다."}}cancelAllUploads(){let e=0;for(let[t,r]of this.activeUploads)r.cancel("All uploads canceled"),this.activeUploads.delete(t),e++;return{success:!0,message:"".concat(e,"개의 업로드가 취소되었습니다."),canceledCount:e}}getErrorMessage(e){switch(e){case 400:return"잘못된 요청입니다.";case 401:return"인증이 필요합니다.";case 403:return"파일에 접근할 권한이 없습니다.";case 404:return"파일을 찾을 수 없습니다.";case 413:return"파일이 너무 큽니다.";case 415:return"지원하지 않는 파일 형식입니다.";case 500:return"서버 오류가 발생했습니다.";case 503:return"서비스를 일시적으로 사용할 수 없습니다.";default:return"알 수 없는 오류가 발생했습니다."}}isRetryableError(e){return!e.response||[408,429,500,502,503,504].includes(e.response.status)}constructor(){this.baseUrl="http://3.38.186.15:5001",this.uploadLimit=0x3200000,this.retryAttempts=3,this.retryDelay=1e3,this.activeUploads=new Map,this.allowedTypes={image:{extensions:[".jpg",".jpeg",".png",".gif",".webp"],mimeTypes:["image/jpeg","image/png","image/gif","image/webp"],maxSize:0xa00000,name:"이미지"},video:{extensions:[".mp4",".webm",".mov"],mimeTypes:["video/mp4","video/webm","video/quicktime"],maxSize:0x3200000,name:"동영상"},audio:{extensions:[".mp3",".wav",".ogg"],mimeTypes:["audio/mpeg","audio/wav","audio/ogg"],maxSize:0x1400000,name:"오디오"},document:{extensions:[".pdf",".doc",".docx",".txt"],mimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain"],maxSize:0x1400000,name:"문서"},archive:{extensions:[".zip",".rar",".7z"],mimeTypes:["application/zip","application/x-rar-compressed","application/x-7z-compressed"],maxSize:0x3200000,name:"압축파일"}}}}let b=new w,k=(e,t,r,n)=>{let[o,a]=(0,s.useState)(null),[l,i]=(0,s.useState)(!1),[c,u]=(0,s.useState)(0),[d,m]=(0,s.useState)(null),g=(0,s.useRef)(null),p=(0,s.useCallback)(async function(s){var o,l,c,d,g;let p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(null===(o=e.current)||void 0===o?void 0:o.connected)||!t){y.F.error("채팅 서버와 연결이 끊어졌습니다.");return}let h=null==r?void 0:null===(l=r.query)||void 0===l?void 0:l.room;if(!h){y.F.error("채팅방 정보를 찾을 수 없습니다.");return}try{i(!0),m(null),u(0);let t=await b.uploadFile(s,e=>u(e));if(!t.success)throw Error(t.message||"파일 업로드에 실패했습니다.");await e.current.emit("chatMessage",{room:h,type:"file",content:p,fileData:{_id:t.data.file._id,filename:t.data.file.filename,originalname:t.data.file.originalname,mimetype:t.data.file.mimetype,size:t.data.file.size}}),a(null),i(!1),u(0)}catch(e){if(console.error("File upload error:",e),(null===(c=e.message)||void 0===c?void 0:c.includes("세션"))||(null===(d=e.message)||void 0===d?void 0:d.includes("인증"))||(null===(g=e.message)||void 0===g?void 0:g.includes("토큰"))){await n();return}m(e.message||"파일 업로드에 실패했습니다."),y.F.error(e.message||"파일 업로드에 실패했습니다.")}finally{i(!1)}},[e,t,r,n]),h=(0,s.useCallback)(async e=>{try{let t=await b.validateFile(e);if(!t.success)throw Error(t.message);let r={file:e,url:URL.createObjectURL(e),name:e.name,type:e.type,size:e.size};a(r),m(null)}catch(e){console.error("File selection error:",e),y.F.error(e.message||"파일 선택 중 오류가 발생했습니다."),g.current&&(g.current.value="")}},[]),f=(0,s.useCallback)(async e=>{e.preventDefault(),e.stopPropagation();let t=Array.from(e.dataTransfer.files);if(0!==t.length)try{await h(t[0])}catch(e){console.error("File drop error:",e),y.F.error(e.message||"파일 드롭 중 오류가 발생했습니다.")}},[h]),v=(0,s.useCallback)(()=>{(null==o?void 0:o.url)&&URL.revokeObjectURL(o.url),a(null),m(null),u(0),g.current&&(g.current.value="")},[o]),x=(0,s.useCallback)(async e=>{var t;let r=null===(t=e.clipboardData)||void 0===t?void 0:t.items;if(!r)return;let n=Array.from(r).find(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(!n)return;let s=n.getAsFile();if(s)try{await h(s),e.preventDefault()}catch(e){console.error("File paste error:",e),y.F.error(e.message||"파일 붙여넣기 중 오류가 발생했습니다.")}},[h]);return(0,s.useEffect)(()=>()=>{(null==o?void 0:o.url)&&URL.revokeObjectURL(o.url)},[o]),{filePreview:o,uploading:l,uploadProgress:c,uploadError:d,fileInputRef:g,setFilePreview:a,setUploading:i,setUploadProgress:u,setUploadError:m,handleFileUpload:p,handleFileSelect:h,handleFileDrop:f,handlePaste:x,removeFilePreview:v}},C=function(e,t,r,n){var o;let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],[l,i]=(0,s.useState)(""),[c,u]=(0,s.useState)(!1),[d,m]=(0,s.useState)(!1),[g,p]=(0,s.useState)(""),[h,f]=(0,s.useState)(0),[v,x]=(0,s.useState)(null),[j,w]=(0,s.useState)(!1),[k,C]=(0,s.useState)(0),[R,S]=(0,s.useState)(null),[N,E]=(0,s.useState)(!1),I=(0,s.useCallback)(e=>{let t=e.target.value;i(t);let r=e.target.selectionStart,n=t.slice(0,r),s=n.lastIndexOf("@");if(-1!==s){let e=n.slice(s+1);if(!e.includes(" ")){p(e.toLowerCase()),m(!0),f(0);return}}m(!1)},[]),T=(0,s.useCallback)(async()=>{var t,n,s;if(!(null===(t=e.current)||void 0===t?void 0:t.connected)){console.warn("Cannot load messages: Socket not connected");return}try{if(N){console.log("Already loading messages, skipping...");return}E(!0);let t=null===(n=a[0])||void 0===n?void 0:n.timestamp;return console.log("Loading more messages:",{roomId:null==r?void 0:null===(s=r.query)||void 0===s?void 0:s.room,before:t,currentMessageCount:a.length}),new Promise((n,s)=>{var o;let a=setTimeout(()=>{E(!1),s(Error("Message loading timed out"))},1e4);e.current.emit("fetchPreviousMessages",{roomId:null==r?void 0:null===(o=r.query)||void 0===o?void 0:o.room,before:t}),e.current.once("previousMessagesLoaded",e=>{clearTimeout(a),E(!1),n(e)}),e.current.once("error",e=>{clearTimeout(a),E(!1),s(e)})})}catch(e){throw console.error("Load more messages error:",e),y.F.error("이전 메시지를 불러오는데 실패했습니다."),E(!1),e}},[e,null==r?void 0:null===(o=r.query)||void 0===o?void 0:o.room,N,a]),L=(0,s.useCallback)(async s=>{var o,a,l,c,d,g;if(!(null===(o=e.current)||void 0===o?void 0:o.connected)||!t){console.error("[Chat] Cannot send message: Socket not connected"),y.F.error("채팅 서버와 연결이 끊어졌습니다.");return}let p=null==r?void 0:null===(a=r.query)||void 0===a?void 0:a.room;if(!p){y.F.error("채팅방 정보를 찾을 수 없습니다.");return}try{if(console.log("[Chat] Sending message:",s),"file"===s.type){w(!0),S(null),C(0);let t=await b.uploadFile(s.fileData.file,e=>C(e));if(!t.success)throw Error(t.message||"파일 업로드에 실패했습니다.");e.current.emit("chatMessage",{room:p,type:"file",content:s.content||"",fileData:{_id:t.data.file._id,filename:t.data.file.filename,originalname:t.data.file.originalname,mimetype:t.data.file.mimetype,size:t.data.file.size}}),x(null),i(""),w(!1),C(0)}else(null===(l=s.content)||void 0===l?void 0:l.trim())&&(e.current.emit("chatMessage",{room:p,type:"text",content:s.content.trim()}),i(""));u(!1),m(!1)}catch(e){if(console.error("[Chat] Message submit error:",e),(null===(c=e.message)||void 0===c?void 0:c.includes("세션"))||(null===(d=e.message)||void 0===d?void 0:d.includes("인증"))||(null===(g=e.message)||void 0===g?void 0:g.includes("토큰"))){await n();return}y.F.error(e.message||"메시지 전송 중 오류가 발생했습니다."),"file"===s.type&&(S(e.message),w(!1))}},[t,r,n,e]),M=(0,s.useCallback)(()=>{u(e=>!e)},[]),A=(0,s.useCallback)(e=>(null==e?void 0:e.participants)?[{_id:"wayneAI",name:"wayneAI",email:"ai@wayne.ai",isAI:!0},{_id:"consultingAI",name:"consultingAI",email:"ai@consulting.ai",isAI:!0},...e.participants].filter(e=>e.name.toLowerCase().includes(g)||e.email.toLowerCase().includes(g)):[],[g]),U=(0,s.useCallback)((e,t)=>{if(!(null==e?void 0:e.current))return;let r=e.current.selectionStart,n=l.slice(0,r).lastIndexOf("@");-1!==n&&(i(l.slice(0,n)+"@".concat(t.name," ")+l.slice(r)),m(!1),setTimeout(()=>{let r=n+t.name.length+2;e.current.focus(),e.current.setSelectionRange(r,r)},0))},[l]),F=(0,s.useCallback)(()=>{x(null),S(null),C(0)},[]);return{message:l,showEmojiPicker:c,showMentionList:d,mentionFilter:g,mentionIndex:h,filePreview:v,uploading:j,uploadProgress:k,uploadError:R,loadingMessages:N,setMessage:i,setShowEmojiPicker:u,setShowMentionList:m,setMentionFilter:p,setMentionIndex:f,setFilePreview:x,setLoadingMessages:E,handleMessageChange:I,handleMessageSubmit:L,handleEmojiToggle:M,handleLoadMore:T,getFilteredParticipants:A,insertMention:U,removeFilePreview:F}},R=(e,t,r,n)=>{let[o]=(0,s.useState)(new Map);return{handleReactionAdd:(0,s.useCallback)(async(s,o)=>{try{var a;if(!(null===(a=e.current)||void 0===a?void 0:a.connected))throw Error("Socket not connected");n(e=>e.map(e=>{if(e._id===s){let r=e.reactions||{},n=r[o]||[];if(!n.includes(t.id))return{...e,reactions:{...r,[o]:[...n,t.id]}}}return e})),await e.current.emit("messageReaction",{messageId:s,reaction:o,type:"add"})}catch(e){console.error("Add reaction error:",e),y.F.error("리액션 추가에 실패했습니다."),n(e=>e.map(e=>{var t;return e._id===s?{...e,reactions:(null===(t=r.find(e=>e._id===s))||void 0===t?void 0:t.reactions)||{}}:e}))}},[e,t,r,n]),handleReactionRemove:(0,s.useCallback)(async(s,o)=>{try{var a;if(!(null===(a=e.current)||void 0===a?void 0:a.connected))throw Error("Socket not connected");n(e=>e.map(e=>{if(e._id===s){let r=e.reactions||{},n=r[o]||[];return{...e,reactions:{...r,[o]:n.filter(e=>e!==t.id)}}}return e})),await e.current.emit("messageReaction",{messageId:s,reaction:o,type:"remove"})}catch(e){console.error("Remove reaction error:",e),y.F.error("리액션 제거에 실패했습니다."),n(e=>e.map(e=>{var t;return e._id===s?{...e,reactions:(null===(t=r.find(e=>e._id===s))||void 0===t?void 0:t.reactions)||{}}:e}))}},[e,t,r,n]),handleReactionUpdate:(0,s.useCallback)(e=>{let{messageId:t,reactions:r}=e;n(e=>e.map(e=>e._id===t?{...e,reactions:r}:e))},[n])}},S=(e,t,r,n)=>{let[o,a]=(0,s.useState)({}),l=(0,s.useCallback)(e=>{console.log("AI message stream started:",e.messageId),a(t=>({...t,[e.messageId]:{_id:e.messageId,type:"ai",aiType:e.aiType,content:"",timestamp:new Date(e.timestamp),isStreaming:!0}})),n()},[n]),i=(0,s.useCallback)(e=>{var t;if(!e.messageId){console.warn("Received AI message chunk without messageId");return}console.log("AI message chunk received:",{messageId:e.messageId,chunkLength:null===(t=e.fullContent)||void 0===t?void 0:t.length,isCodeBlock:e.isCodeBlock}),a(t=>t[e.messageId]?{...t,[e.messageId]:{...t[e.messageId],content:e.fullContent,isCodeBlock:e.isCodeBlock}}:(console.warn("No existing streaming message for chunk:",e.messageId),t)),r&&n()},[r,n]),c=(0,s.useCallback)(e=>{console.log("AI message stream completed:",e.messageId),a(t=>{let{[e.messageId]:r,...n}=t;return n}),t(t=>[...t,{_id:e._id,type:"ai",aiType:e.aiType,content:e.content,timestamp:new Date(e.timestamp),isComplete:!0}]),n()},[t,n]),u=(0,s.useCallback)(e=>{console.error("AI message error:",e),a(t=>{let{[e.messageId]:r,...n}=t;return n}),y.F.error("AI 응답 오류: ".concat(e.error))},[]),d=(0,s.useCallback)(()=>{if(!e.current){console.warn("Cannot setup AI message listeners: socket not initialized");return}let t=e.current;return t.off("aiMessageStart").off("aiMessageChunk").off("aiMessageComplete").off("aiMessageError"),t.on("aiMessageStart",l),t.on("aiMessageChunk",i),t.on("aiMessageComplete",c),t.on("aiMessageError",u),()=>{t.off("aiMessageStart").off("aiMessageChunk").off("aiMessageComplete").off("aiMessageError")}},[e,l,i,c,u]);return{streamingMessages:o,setStreamingMessages:a,handleAIMessageStart:l,handleAIMessageChunk:i,handleAIMessageComplete:c,handleAIMessageError:u,setupAIMessageListeners:d,sendAIMessage:(0,s.useCallback)(async(t,r)=>{var n;if(!(null===(n=e.current)||void 0===n?void 0:n.connected))throw Error("Socket not connected");try{console.log("Sending AI message:",{aiType:t,content:r}),e.current.emit("chatMessage",{type:"ai",aiType:t,content:r.trim()})}catch(e){throw console.error("Send AI message error:",e),y.F.error("AI 메시지 전송에 실패했습니다."),e}},[e])}},N=function(e,t){var r;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],[o,a]=(0,s.useState)(!0),[l,i]=(0,s.useState)(!0),[c,u]=(0,s.useState)(!1),[d,m]=(0,s.useState)(!1),[g,p]=(0,s.useState)(!1),h=(0,s.useRef)(null),f=(0,s.useRef)(0),v=(0,s.useRef)(0),y=(0,s.useRef)(0),x=(0,s.useRef)(!1),j=(0,s.useRef)((null==n?void 0:n.length)||0),w=(0,s.useRef)(null),b=(0,s.useRef)(null),k=(0,s.useRef)(null),C=(0,s.useRef)(!1),R=(0,s.useCallback)((e,t)=>{console.debug("[ScrollHandling] ".concat(e,":"),{...t,timestamp:new Date().toISOString()})},[]),S=(0,s.useCallback)(()=>{if(!h.current)return{isAtBottom:!0,isAtTop:!1};let{scrollTop:e,scrollHeight:t,clientHeight:r}=h.current;return{isAtBottom:t-(e+r)<100,isAtTop:e<30,scrollTop:e,scrollHeight:t,clientHeight:r}},[]),N=(0,s.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";!g&&h.current&&requestAnimationFrame(()=>{try{let t=h.current;if(!t)return;let{scrollHeight:r,clientHeight:n}=t,s=r-n;t.scrollTo({top:s,behavior:"auto"===e?"auto":"smooth"}),R("scrollToBottom",{scrollHeight:r,clientHeight:n,maxScrollTop:s,behavior:e,isLoadingPrevious:g})}catch(e){console.error("Scroll error:",e)}})},[g,R]),E=(0,s.useCallback)(async()=>{if(!l||c||x.current||C.current){R("loadMore prevented",{hasMoreMessages:l,loadingMessages:c,isLoading:x.current,loadMoreTriggered:C.current});return}try{var r;if(!(null==e?void 0:null===(r=e.current)||void 0===r?void 0:r.connected))throw Error("Socket not connected");let s=h.current;if(!s)return;p(!0),x.current=!0,C.current=!0,f.current=s.scrollHeight,v.current=s.scrollTop,y.current=s.scrollTop,u(!0);let o=null==n?void 0:n[0];if(!o){i(!1),x.current=!1,C.current=!1,u(!1),p(!1);return}let a=new Promise((r,n)=>{var s;e.current.emit("fetchPreviousMessages",{roomId:null==t?void 0:null===(s=t.query)||void 0===s?void 0:s.room,before:o.timestamp}),e.current.once("previousMessagesLoaded",e=>{r(e)}),e.current.once("error",e=>{p(!1),n(e)}),setTimeout(()=>{p(!1),n(Error("Timeout loading messages"))},1e4)});await a}catch(e){console.error("Load more error:",e),p(!1),x.current=!1,C.current=!1,u(!1)}},[l,c,n,e,null==t?void 0:null===(r=t.query)||void 0===r?void 0:r.room,u]),I=(0,s.useCallback)(()=>{if(console.log("Scroll event triggered"),!h.current){console.log("No messagesEndRef");return}w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{console.log("Scroll timeout triggered");let e=h.current;if(!e){console.log("No container in timeout");return}let{scrollTop:t,scrollHeight:r,clientHeight:n}=e,s=r-(t+n)<100,o=t<30;console.log("Scroll position:",{scrollTop:t,scrollHeight:r,clientHeight:n,isAtTop:o,isAtBottom:s}),a(s),!o||(console.log("Is at top, checking conditions:",{hasMoreMessages:l,loadingMessages:c,isLoading:x.current,loadMoreTriggered:C.current}),!l||c||x.current||C.current||(console.log("Calling tryLoadMoreMessages"),E()))},150)},[l,c,E,R]);return(0,s.useEffect)(()=>{let e=(null==n?void 0:n.length)||0;e>j.current&&!g&&(o&&N(),j.current=e)},[n,o,N,g]),(0,s.useEffect)(()=>{d||!((null==n?void 0:n.length)>0)||g||(N("auto"),m(!0),R("initialScroll"))},[null==n?void 0:n.length,d,N,g,R]),(0,s.useEffect)(()=>{!c&&f.current>0&&(k.current&&cancelAnimationFrame(k.current),k.current=requestAnimationFrame(()=>{try{let e=h.current;if(!e)return;let t=e.scrollHeight,r=t-f.current,n=v.current+r;if(R("scroll restoration",{previousHeight:f.current,newHeight:t,heightDiff:r,previousScrollTop:v.current,newScrollTop:n,isLoadingPrevious:g}),g){let t=e.style.scrollBehavior;e.style.scrollBehavior="auto",e.scrollTop=n,requestAnimationFrame(()=>{e.style.scrollBehavior=t})}f.current=0,v.current=0,y.current=n,x.current=!1,C.current=!1,setTimeout(()=>{p(!1)},100)}catch(e){console.error("Scroll restoration error:",e),x.current=!1,C.current=!1,p(!1)}}))},[c,R]),(0,s.useEffect)(()=>()=>{w.current&&clearTimeout(w.current),b.current&&clearTimeout(b.current),k.current&&cancelAnimationFrame(k.current),x.current=!1,C.current=!1,p(!1)},[]),{isNearBottom:o,hasMoreMessages:l,loadingMessages:c,initialScrollDone:d,messagesEndRef:h,scrollToBottom:N,handleScroll:I,tryLoadMoreMessages:E,checkScrollPosition:S,setHasMoreMessages:i,setLoadingMessages:u,setInitialScrollDone:m,setIsNearBottom:a,isLoadingPreviousMessages:g}},E=function(e){var t,r;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,[o,a]=(0,s.useState)(!1),[l,i]=(0,s.useState)(null),[c,u]=(0,s.useState)(0),[d,m]=(0,s.useState)(!1),g=(0,s.useRef)(null),p=(0,s.useRef)(null),h=(0,s.useRef)(null),f=(0,s.useRef)(null),x=(0,s.useCallback)(()=>{p.current&&clearTimeout(p.current),h.current&&clearInterval(h.current),f.current&&clearTimeout(f.current)},[]),j=(0,s.useCallback)(e=>Math.min(1e3*Math.pow(2,e),1e4),[]),w=(0,s.useCallback)(async(t,r)=>{console.error("Connection error:",t),a(!1),m(!0);try{var s,o,l;if((null==t?void 0:null===(s=t.message)||void 0===s?void 0:s.includes("세션"))||(null==t?void 0:null===(o=t.message)||void 0===o?void 0:o.includes("인증"))||(null==t?void 0:null===(l=t.message)||void 0===l?void 0:l.includes("토큰"))){await (null==r?void 0:r());return}if(c<n){let t=j(c);console.log("Retrying connection in ".concat(t,"ms... (Attempt ").concat(c+1,"/").concat(n,")")),x(),p.current=setTimeout(async()=>{try{if(g.current){var t;await g.current.connect(),a(!0),m(!1),u(0),i(null),(null==e?void 0:null===(t=e.query)||void 0===t?void 0:t.room)&&g.current.emit("joinRoom",e.query.room)}}catch(e){console.error("Retry connection failed:",e),u(e=>e+1),w(e,r)}},t)}else m(!1),y.F.error("채팅 서버와 연결할 수 없습니다. 페이지를 새로고침해주세요.")}catch(e){console.error("Error handling connection error:",e),m(!1)}},[c,n,x,j,null==e?void 0:null===(t=e.query)||void 0===t?void 0:t.room]),b=(0,s.useCallback)(async(t,r)=>{if(!d)try{if(!(null==t?void 0:t.token)||!(null==t?void 0:t.sessionId))throw Error("Invalid user credentials");i(null),u(0),m(!0),x(),g.current&&(g.current.disconnect(),a(!1));let s=await v.Z.connect({auth:{token:t.token,sessionId:t.sessionId},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:n,reconnectionDelay:j(0),reconnectionDelayMax:1e4,timeout:2e4});g.current=s,f.current=setTimeout(()=>{s.connected||w(Error("Connection timeout"),r)},2e4),s.on("connect",()=>{var t;a(!0),m(!1),x(),(null==e?void 0:null===(t=e.query)||void 0===t?void 0:t.room)&&s.emit("joinRoom",e.query.room)}),s.on("connect_error",e=>{w(e,r)}),s.on("disconnect",e=>{console.log("Socket disconnected:",e),a(!1),"io server disconnect"!==e&&"io client disconnect"!==e&&w(Error("Disconnected: ".concat(e)),r)})}catch(e){var s,o,l;if(console.error("Reconnection failed:",e),a(!1),m(!1),(null===(s=e.message)||void 0===s?void 0:s.includes("세션"))||(null===(o=e.message)||void 0===o?void 0:o.includes("인증"))||(null===(l=e.message)||void 0===l?void 0:l.includes("토큰"))){await (null==r?void 0:r());return}y.F.error("재연결에 실패했습니다.")}},[d,x,j,n,null==e?void 0:null===(r=e.query)||void 0===r?void 0:r.room,w]);return(0,s.useEffect)(()=>x,[x]),(0,s.useEffect)(()=>{let e=g.current;if(!e)return;let t=()=>{console.log("Socket connected"),a(!0),m(!1),u(0),i(null)},r=()=>{console.log("Socket disconnected"),a(!1)};return e.on("connect",t),e.on("disconnect",r),a(e.connected),()=>{e.off("connect",t),e.off("disconnect",r)}},[g.current]),(0,s.useEffect)(()=>{let e=()=>{console.log("Network is online"),o||d||b()},t=()=>{console.log("Network is offline"),a(!1)};return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[o,d,b]),{connected:o,error:l,socketRef:g,isReconnecting:d,setConnected:a,setError:i,handleConnectionError:w,handleReconnect:b,cleanup:x}},I=(e,t,r,n,o,a,l,i,c,u,d,m,g,p,h,y,x,j)=>{let w=(0,s.useRef)(null),b=(0,s.useRef)(null),k=(0,s.useRef)(null),C=(0,s.useRef)(null),R=(0,s.useRef)(0),S=(0,s.useRef)(0),N=(0,s.useCallback)(()=>{b.current&&(clearTimeout(b.current),b.current=null),k.current&&(clearTimeout(k.current),k.current=null),C.current&&(clearTimeout(C.current),C.current=null)},[]),E=async()=>{try{if(!f.Z.getCurrentUser())throw Error("No user session found");if(await f.Z.refreshToken()&&r.current)return!0}catch(e){console.error("Token refresh failed:",e)}return r.current&&(await f.Z.logout(),n.replace("/?redirect="+n.asPath)),!1},I=(0,s.useCallback)(async()=>{try{var t;let r=f.Z.getCurrentUser();if(!(null==r?void 0:r.token)||!(null==r?void 0:r.sessionId))throw Error("Invalid authentication state");if(null===(t=e.current)||void 0===t?void 0:t.connected)return console.log("Reusing existing socket connection"),e.current;if(e.current){console.log("Cleaning up existing socket");let t=e.current;(null==x?void 0:x.get(t.id))&&(await new Promise(e=>{t.emit("leaveRoom",x.get(t.id)),setTimeout(e,1e3)}),x.delete(t.id)),t.disconnect(),t.removeAllListeners(),e.current=null,await new Promise(e=>setTimeout(e,2e3))}let n=await v.Z.connect({auth:{token:r.token,sessionId:r.sessionId},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:3e4,pingTimeout:3e4,pingInterval:25e3,forceNew:!0,autoConnect:!0});return new Promise((e,t)=>{let r=!1,s=setTimeout(()=>{r||(m(),t(Error("Socket connection timeout")))},3e4),o=()=>{r||(r=!0,clearTimeout(s),n.removeListener("connect_error",a),n.removeListener("error",a),R.current=0,e(n))},a=e=>{r||(r=!0,clearTimeout(s),console.error("Socket connection error:",e),t(e))};if(n.connected){o();return}n.once("connect",o),n.once("connect_error",a),n.once("error",a)})}catch(e){throw console.error("Socket setup error:",e),"Invalid authentication state"===e.message&&n.replace("/?error=auth_required"),e}},[x,m,n]),T=(0,s.useCallback)(async e=>{try{let t=f.Z.getCurrentUser();if(!(null==t?void 0:t.token)||!(null==t?void 0:t.sessionId))throw await E(),Error("인증 정보가 유효하지 않습니다.");if(!e||!r.current)throw Error("채팅방 정보가 올바르지 않습니다.");let n=await fetch("".concat("http://3.38.186.15:5001","/api/rooms/").concat(e),{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-auth-token":t.token,"x-session-id":t.sessionId},credentials:"include"});if(!n.ok){if(401===n.status){if(await E()&&r.current)return T(e);throw Error("인증이 만료되었습니다.")}throw Error("채팅방 정보를 불러오는데 실패했습니다.")}let s=await n.json();if(!s.success||!s.data)throw Error("채팅방 데이터가 올바르지 않습니다.");return s.data}catch(e){throw console.error("Fetch room data error:",e),e}},[r,E]),L=(0,s.useCallback)(async t=>{if(!t||!r.current)throw Error("잘못된 채팅방 정보입니다.");let n=e.current;if(!(null==n?void 0:n.connected))throw Error("Socket not connected");return new Promise((e,r)=>{let s=setTimeout(()=>{r(Error("채팅방 입장 시간이 초과되었습니다."))},2e4),o=r=>{clearTimeout(s),null==x||x.set(n.id,t),n.off("joinRoomError",a),n.off("error",a),e(r)},a=e=>{clearTimeout(s),n.off("joinRoomSuccess",o),n.off("error",a),r(e)};n.once("joinRoomSuccess",o),n.once("joinRoomError",a),n.once("error",a),n.emit("joinRoom",t)})},[e,r,x]),M=(0,s.useCallback)(async t=>{let r=async function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((s,o)=>{var a;let l;if(!(null===(a=e.current)||void 0===a?void 0:a.connected)){o(Error("Socket not connected"));return}let i=()=>{var t,r;l&&clearTimeout(l),null===(t=e.current)||void 0===t||t.off("previousMessagesLoaded",c),null===(r=e.current)||void 0===r||r.off("error",u)},c=e=>{if(i(),!e||!Array.isArray(e.messages)){n<3?(console.log("Invalid message format, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{r(n+1).then(s).catch(o)},2e3)):o(Error("잘못된 메시지 응답 형식입니다."));return}j(e.messages,e.hasMore,!0),s(e)},u=e=>{i(),n<3?(console.log("Message loading failed, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{r(n+1).then(s).catch(o)},2e3)):o(e)};e.current.once("previousMessagesLoaded",c),e.current.once("error",u),l=setTimeout(()=>{i(),n<3?(console.log("Message loading timed out, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{r(n+1).then(s).catch(o)},2e3)):o(Error("메시지 로딩 시간이 초과되었습니다."))},3e4),e.current.emit("fetchPreviousMessages",{roomId:t,limit:30})})};try{return await r()}catch(t){var n;if(!(null===(n=e.current)||void 0===n?void 0:n.connected))return console.log("Socket disconnected, attempting to reconnect..."),await I(),r();throw t}},[e,j,I]),A=(0,s.useCallback)(async()=>(w.current||(w.current=(async()=>{try{var s;h.current=!0,u(!0),a(null),S.current=0,console.log("Setting up socket connection..."),e.current=await I(),console.log("Fetching room data...");let l=await T(n.query.room);t&&l.participants&&!l.participants.some(e=>e._id===t.id||e.id===t.id)&&(l.participants=[...l.participants,{_id:t.id,id:t.id,name:t.name,email:t.email}]),o(l),console.log("Setting up event listeners..."),r.current&&d(),r.current&&(null===(s=e.current)||void 0===s?void 0:s.connected)&&(console.log("Joining room..."),await L(n.query.room),console.log("Loading initial messages..."),await M(n.query.room)),r.current&&(y.current=!0,p(!0)),console.log("Room setup completed successfully")}catch(t){throw console.error("Room setup error:",t),r.current&&(a(t.message.includes("시간 초과")?"채팅방 연결 시간이 초과되었습니다.":t.message||"채팅방 연결에 실패했습니다."),m(),e.current&&(e.current.disconnect(),e.current=null)),t}finally{r.current&&(u(!1),h.current=!1),N(),w.current=null}})()),w.current),[n,e,r,I,T,L,M,m,d,a,o,u,p,h,y,N]);return(0,s.useEffect)(()=>()=>{N(),w.current=null,h.current=!1,y.current=!1,R.current=0,S.current=0,e.current&&(console.log("Cleaning up socket connection"),e.current.disconnect(),e.current=null)},[N]),(0,s.useEffect)(()=>{let e=()=>{!y.current&&r.current&&(console.log("Network is back online, attempting to reconnect..."),A().catch(e=>{console.error("Auto reconnect failed:",e)}))};return window.addEventListener("online",e),()=>{window.removeEventListener("online",e)}},[A]),{setupRoom:A,joinRoom:L,loadInitialMessages:M,fetchRoomData:T,handleSessionError:E}},T={UNMOUNT:"unmount"},L=()=>{var e;let t=(0,h.useRouter)(),[r,n]=(0,s.useState)(null),[o,a]=(0,s.useState)([]),[l,i]=(0,s.useState)(null),[c,u]=(0,s.useState)(""),[d,m]=(0,s.useState)(!0),[g,p]=(0,s.useState)("checking"),[v,x]=(0,s.useState)(null),[j,w]=(0,s.useState)(!1),b=(0,s.useRef)(null),L=(0,s.useRef)(0),M=(0,s.useRef)(!0),A=(0,s.useRef)(!1),U=(0,s.useRef)(!1),F=(0,s.useRef)(!1),z=(0,s.useRef)(!1);(0,s.useRef)(0);let D=(0,s.useRef)(new Map),P=(0,s.useRef)(new Set),_=(0,s.useRef)(!1),B=(0,s.useRef)(!1);(0,s.useRef)(0);let O=(0,s.useRef)(new Set),q=(0,s.useRef)(null);(0,s.useRef)(0),(0,s.useRef)(!1),(0,s.useRef)(!1);let{connected:Z,socketRef:W,handleConnectionError:H,handleReconnect:K,setConnected:Y}=E(t),{isNearBottom:X,hasMoreMessages:$,loadingMessages:J,messagesEndRef:V,scrollToBottom:G,handleScroll:Q,setHasMoreMessages:ee,setLoadingMessages:et}=N(W,t,o),{streamingMessages:er,setStreamingMessages:en,handleAIMessageStart:es,handleAIMessageChunk:eo,handleAIMessageComplete:ea,handleAIMessageError:el,setupAIMessageListeners:ei}=S(W,a,X,G),{message:ec,showEmojiPicker:eu,showMentionList:ed,mentionFilter:em,mentionIndex:eg,filePreview:ep,uploading:eh,uploadProgress:ef,uploadError:ev,setMessage:ey,setShowEmojiPicker:ex,setShowMentionList:ej,setMentionFilter:ew,setMentionIndex:eb,setFilePreview:ek,handleMessageChange:eC,handleMessageSubmit:eR,handleLoadMore:eS,handleEmojiToggle:eN,getFilteredParticipants:eE,insertMention:eI,removeFilePreview:eT}=C(W,l,t),eL=(0,s.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"MANUAL";if(M.current&&t.query.room)try{var r;if(z.current){console.log("[Chat] Cleanup already in progress, skipping...");return}z.current=!0,console.log("[Chat] Starting cleanup (reason: ".concat(e,")")),"UNMOUNT"!==e&&t.query.room&&(null===(r=W.current)||void 0===r?void 0:r.connected)&&(console.log("[Chat] Emitting leaveRoom event"),W.current.emit("leaveRoom",t.query.room)),W.current&&"RECONNECT"!==e&&(console.log("[Chat] Cleaning up socket listeners..."),W.current.off("message"),W.current.off("previousMessages"),W.current.off("previousMessagesLoaded"),W.current.off("participantsUpdate"),W.current.off("aiMessageStart"),W.current.off("aiMessageChunk"),W.current.off("aiMessageComplete"),W.current.off("aiMessageError"),W.current.off("messageReactionUpdate"),W.current.off("session_ended"),W.current.off("error")),q.current&&(clearTimeout(q.current),q.current=null),O.current.clear(),P.current.clear(),_.current=!1,"MANUAL"===e&&M.current?(en({}),u(null),m(!1),et(!1),a([]),D.current.size>0&&D.current.clear()):"DISCONNECT"===e&&M.current&&u("채팅 연결이 끊어졌습니다. 재연결을 시도합니다."),console.log("[Chat] Cleanup completed (reason: ".concat(e,")"))}catch(e){console.error("[Chat] Cleanup error:",e),M.current&&u("채팅방 정리 중 오류가 발생했습니다.")}finally{z.current=!1}},[a,en,u,m,et,M,W,t.query.room]),eM=(0,s.useCallback)(()=>W.current?d?"connecting":c?"error":W.current.connected?"connected":"disconnected":"disconnected",[d,c,W]),{handleReactionAdd:eA,handleReactionRemove:eU,handleReactionUpdate:eF}=R(W,l,o,a),ez=(0,s.useCallback)(function(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{if(!Array.isArray(e))throw Error("Invalid messages format");a(t=>{let r=e.filter(e=>!(!e._id||O.current.has(e._id))&&(O.current.add(e._id),!0)),n=[...t,...r].sort((e,t)=>new Date(e.timestamp||0)-new Date(t.timestamp||0)),s=new Map;return n.forEach(e=>s.set(e._id,e)),Array.from(s.values())}),r?(ee(t),B.current=!0,X&&requestAnimationFrame(()=>G("auto"))):ee(t)}catch(e){throw console.error("Message processing error:",e),e}},[a,ee,X,G]),eD=(0,s.useCallback)(async()=>{var e,r;if(!(null===(e=W.current)||void 0===e?void 0:e.connected)||J){console.warn("Cannot load messages: Socket not connected or already loading");return}try{et(!0);let e=null===(r=o[0])||void 0===r?void 0:r.timestamp;q.current&&clearTimeout(q.current);let n=new Promise((r,n)=>{var s;W.current.emit("fetchPreviousMessages",{roomId:null==t?void 0:null===(s=t.query)||void 0===s?void 0:s.room,before:e}),W.current.once("previousMessagesLoaded",r),W.current.once("error",n)}),s=new Promise((e,t)=>{q.current=setTimeout(()=>{t(Error("Message loading timed out"))},1e4)}),a=await Promise.race([n,s]);a.messages&&ez(a.messages,a.hasMore,!1)}catch(e){console.error("Load previous messages error:",e),y.F.error("이전 메시지를 불러오는데 실패했습니다."),ee(!1)}finally{et(!1),q.current&&clearTimeout(q.current)}},[W,null==t?void 0:null===(e=t.query)||void 0===e?void 0:e.room,J,o,ez,ee]),eP=(0,s.useCallback)(()=>{W.current&&M.current&&(console.log("Setting up event listeners..."),W.current.on("participantsUpdate",e=>{M.current&&(console.log("Participants updated:",e),n(t=>({...t,participants:e||[]})))}),W.current.on("message",e=>{e&&M.current&&!_.current&&e._id&&!O.current.has(e._id)&&(console.log("Received message:",e),O.current.add(e._id),a(t=>t.some(t=>t._id===e._id)?t:[...t,e]),X&&G())}),W.current.on("previousMessages",e=>{if(M.current&&!_.current)try{if(_.current=!0,console.log("Previous messages response:",e),!e||"object"!=typeof e)throw Error("Invalid response format");let{messages:t=[],hasMore:r}=e,n=0===o.length;ez(t,r,n),et(!1)}catch(e){console.error("Error processing messages:",e),et(!1),u("메시지 처리 중 오류가 발생했습니다."),ee(!1)}finally{_.current=!1}}),ei(),W.current.on("messageReactionUpdate",e=>{M.current&&eF(e)}),W.current.on("session_ended",()=>{M.current&&(eL(),f.Z.logout(),t.replace("/?error=session_expired"))}),W.current.on("error",e=>{M.current&&(console.error("Socket error:",e),u(e.message||"채팅 연결에 문제가 발생했습니다."))}))},[X,G,o.length,ez,ei,ee,eL,t,eF,et,u]),{setupRoom:e_,joinRoom:eB,loadInitialMessages:eO,fetchRoomData:eq,handleSessionError:eZ}=I(W,l,M,t,n,u,a,ee,et,m,eP,eL,d,w,A,U,D.current,ez);(0,s.useEffect)(()=>{if(!W.current||!l)return;let e=()=>{!M.current||(console.log("Socket connected successfully"),p("connected"),Y(!0),!t.query.room||U.current||A.current||j||(F.current=!0,e_().catch(e=>{console.error("Setup room error:",e),u("채팅방 연결에 실패했습니다.")})))},r=e=>{M.current&&(console.log("Socket disconnected:",e),p("disconnected"),F.current=!1,U.current=!1)},n=e=>{M.current&&(console.error("Socket connection error:",e),p("error"),u("채팅 서버와의 연결이 끊어졌습니다."))},s=e=>{M.current&&(console.log("Reconnection attempt ".concat(e)),p("connecting"))},o=()=>{M.current&&(console.log("Reconnected successfully"),p("connected"),Y(!0),u(""),t.query.room&&e_().catch(e=>{console.error("Room reconnection error:",e),u("채팅방 재연결에 실패했습니다.")}))};return W.current.on("connect",e),W.current.on("disconnect",r),W.current.on("connect_error",n),W.current.on("reconnecting",s),W.current.on("reconnect",o),p(W.current.connected?"connected":"disconnected"),()=>{W.current&&(W.current.off("connect",e),W.current.off("disconnect",r),W.current.off("connect_error",n),W.current.off("reconnecting",s),W.current.off("reconnect",o))}},[t.query.room,e_,Y,l,j,u]),(0,s.useEffect)(()=>{let e=async()=>{if(A.current)return;let e=f.Z.getCurrentUser();if(!e){t.replace("/?redirect="+t.asPath);return}if(l||i(e),!j&&t.query.room)try{A.current=!0,console.log("Initializing chat room..."),await e_()}catch(e){console.error("Chat initialization error:",e),u("채팅방 초기화에 실패했습니다.")}finally{A.current=!1}};M.current=!0,t.query.room&&e();let r=setInterval(()=>{M.current&&(f.Z.getCurrentUser()||(clearInterval(r),t.replace("/?redirect="+t.asPath)))},6e4);return()=>{var e;console.log("[Chat] Component unmounting..."),M.current=!1,clearInterval(r),q.current&&clearTimeout(q.current),(null===(e=W.current)||void 0===e?void 0:e.connected)&&t.query.room&&!z.current&&eL(T.UNMOUNT)}},[t,eL,e_,l,j,u]);let{fileInputRef:eW,uploading:eH,uploadProgress:eK,uploadError:eY,handleFileUpload:eX,handleFileSelect:e$,handleFileDrop:eJ,removeFilePreview:eV}=k(W,l,t),eG=(0,s.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eR(e))},[eR]);return{room:r,messages:o,streamingMessages:er,error:c,loading:d,connected:Z,currentUser:l,message:ec,showEmojiPicker:eu,showMentionList:ed,mentionFilter:em,mentionIndex:eg,filePreview:ep,uploading:eh,uploadProgress:ef,uploadError:ev,isNearBottom:X,hasMoreMessages:$,loadingMessages:J,fileInputRef:eW,messageInputRef:b,messagesEndRef:V,socketRef:W,handleMessageChange:eC,handleMessageSubmit:eR,handleEmojiToggle:eN,handleKeyDown:eG,handleScroll:Q,handleLoadMore:eD,handleConnectionError:H,handleReconnect:K,getFilteredParticipants:eE,insertMention:eI,scrollToBottom:G,removeFilePreview:eT,handleReactionAdd:eA,handleReactionRemove:eU,cleanup:eL,setMessage:ey,setShowEmojiPicker:ex,setShowMentionList:ej,setMentionFilter:ew,setMentionIndex:eb,setStreamingMessages:en,setError:u,connectionStatus:eM(),messageLoadError:v,retryMessageLoad:(0,s.useCallback)(()=>{M.current&&(L.current=0,P.current.clear(),O.current.clear(),B.current=!1,eO(t.query.room))},[eO,t.query.room])}},M=s.memo(e=>{let{msg:t}=e,r=new Date(t.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 ");return console.log(r),(0,n.jsxs)("div",{className:"message-system",children:[t.content,r&&(0,n.jsx)("div",{className:"message-time",children:r})]})});var A=r(18237),U=r(16893),F=r(34585),z=r(13384),D=r(93809),P=r(95343),_=r(98683),B=r(84283);let O=s.memo(e=>{let{content:t,isAI:r=!1}=e,[o,a]=(0,s.useState)(new Map),l=(0,s.useCallback)(async(e,t)=>{try{await navigator.clipboard.writeText(e),a(e=>new Map(e).set(t,!0)),y.F.success("코드가 클립보드에 복사되었습니다."),setTimeout(()=>{a(e=>{let r=new Map(e);return r.delete(t),r})},1e3)}catch(e){console.error("Failed to copy:",e),y.F.error("복사에 실패했습니다.")}},[]),c=(0,s.useMemo)(()=>e=>{let t;let r=/@(wayneAI|consultingAI|[\w.-]+)/g,s=[],o=0;for(;null!==(t=r.exec(e));){t.index>o&&s.push((0,n.jsx)("span",{children:e.slice(o,t.index)},"text-".concat(o)));let r=t[1],a="wayneAI"===r||"consultingAI"===r,l=a?"wayneAI"===r?"Wayne AI":"Consulting AI":r,i=a?"mention mention-bot ".concat("wayneAI"===r?"mention-wayne":"mention-consulting"):"mention mention-user";s.push((0,n.jsxs)("span",{className:i,children:["@",l]},"mention-".concat(t.index))),o=t.index+t[0].length}return o<e.length&&s.push((0,n.jsx)("span",{children:e.slice(o)},"text-".concat(o))),s},[]),u=(0,s.useMemo)(()=>({p:e=>{let{children:t}=e;return 1!==t.length||"string"!=typeof t[0]||t[0].includes("\n")?(0,n.jsx)(i.x,{typography:"body2",children:t}):(0,n.jsx)(i.x,{typography:"body2",children:c(t[0])})},code(e){let{node:t,inline:r,className:s,children:a,...i}=e,c=/language-(\w+)/.exec(s||""),u=Math.random().toString(36).substr(2,9);return!r&&c?(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsx)("button",{onClick:()=>l(String(a).replace(/\n$/,""),u),className:"absolute right-2 top-2 p-2 rounded bg-gray-800/50 hover:bg-gray-800/80 transition-all duration-200 opacity-0 group-hover:opacity-100 z-10",title:"코드 복사",children:o.get(u)?(0,n.jsx)(A.eje,{size:16,style:{color:"var(--vapor-color-success)"}}):(0,n.jsx)(A.TIy,{size:16,style:{color:"var(--vapor-color-gray-500)"}})}),(0,n.jsx)(_.Z,{style:B.Ro,language:c[1],PreTag:"div",showLineNumbers:!0,wrapLines:!0,...i,children:String(a).replace(/\n$/,"")})]}):(0,n.jsx)("code",{className:"rounded px-1.5 py-0.5 text-sm bg-black/10",...i,children:a})},h1:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("h1",{className:"md-heading md-h1",...s,children:r})},h2:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("h2",{className:"md-heading md-h2",...s,children:r})},h3:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("h3",{className:"md-heading md-h3",...s,children:r})},ul:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("ul",{className:"md-list md-ul",...s,children:r})},ol:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("ol",{className:"md-list md-ol",...s,children:r})},li:e=>{let{node:t,children:r,...s}=e,o=t.children.some(e=>"element"===e.type&&"input"===e.tagName&&"checkbox"===e.properties.type);return(0,n.jsx)("li",{className:"md-list-item ".concat(o?"list-none":""),...s,children:r})},a:e=>{let{node:t,children:r,href:s,...o}=e;return(0,n.jsx)("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"md-link",...o,children:r})},img:e=>{let{node:t,src:r,alt:s,...o}=e;return(0,n.jsx)("img",{src:r,alt:s,className:"md-image",loading:"lazy",onError:e=>{e.target.src="/placeholder-image.png"},...o})},table:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("div",{className:"md-table-wrapper",children:(0,n.jsx)("table",{className:"md-table",...s,children:r})})},blockquote:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("blockquote",{className:"md-blockquote",...s,children:r})},em:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("em",{className:"md-italic",...s,children:r})},strong:e=>{let{node:t,children:r,...s}=e;return(0,n.jsx)("strong",{className:"md-bold",...s,children:r})}}),[c,l,o]),d=(0,s.useMemo)(()=>"string"==typeof t&&!t.includes("```")&&!t.includes("`")&&!t.includes("#")&&!t.includes("*")&&!t.includes("_")&&!t.includes("[")&&!t.includes("|"),[t]);return"string"!=typeof t?String(t):d&&t.includes("@")?(0,n.jsx)(i.x,{typography:"body2",className:"message-text",children:c(t)}):(0,n.jsx)(F.U,{remarkPlugins:[z.Z,D.Z,P.Z],components:u,children:t})});var q=r(73935),Z=r(32726),W=r(26638),H=r(73814);let K=function(e){let{onSelect:t}=e;return(0,n.jsx)("div",{className:"emoji-picker-wrapper",children:(0,n.jsx)(H.Z,{data:W,onEmojiSelect:t,theme:"light",set:"native",locale:"ko",previewPosition:"none",skinTonePosition:"none",emojiButtonSize:30,emojiSize:20,maxFrequentRows:4,perLine:9})})},Y=e=>{let{messageId:t,messageContent:r,reactions:o,currentUserId:a,onReactionAdd:l,onReactionRemove:i,isMine:c=!1,room:u=null}=e,[m,g]=(0,s.useState)(!1),[p,h]=(0,s.useState)({}),[f,v]=(0,s.useState)(0),x=(0,s.useRef)(null),j=(0,s.useRef)(null),w=(0,s.useRef)(null),b=(0,s.useRef)({});(0,s.useRef)(null);let k=(0,s.useCallback)(e=>{var t,r;let n=null===(t=x.current)||void 0===t?void 0:t.contains(e.target),s=null===(r=j.current)||void 0===r?void 0:r.contains(e.target);n||s||g(!1)},[]);(0,s.useEffect)(()=>(m&&document.addEventListener("mousedown",k),()=>{document.removeEventListener("mousedown",k)}),[m,k]);let C=(0,s.useCallback)(async()=>{try{await navigator.clipboard.writeText(r),y.F.success("메시지가 클립보드에 복사되었습니다.")}catch(e){console.error("Copy failed:",e),y.F.error("메시지 복사에 실패했습니다.")}},[r]),R=(0,s.useCallback)(e=>{try{var r;let n=e.native||e;(null==o?void 0:null===(r=o[n])||void 0===r?void 0:r.includes(a))?null==i||i(t,n):null==l||l(t,n),g(!1)}catch(e){console.error("Reaction handling error:",e)}},[t,o,a,l,i]),S=(0,s.useCallback)(e=>{h(t=>({...t,[e]:!t[e]}))},[]),N=(0,s.useCallback)((e,t)=>{if(!t||!(null==u?void 0:u.participants))return"";if(!Array.isArray(u.participants))return console.warn("room.participants is not an array:",u.participants),"";let r=new Map(u.participants.map(e=>[String(e._id||e.id),e.name]));return[...new Set(t.map(e=>{let t=String(e);return t===String(a)?"나":r.get(t)||"알 수 없는 사용자"}))].sort((e,t)=>"나"===e?-1:"나"===t?1:e.localeCompare(t)).join(", ")},[a,u]),E=(0,s.useCallback)(()=>o&&0!==Object.keys(o).length?(0,n.jsx)("div",{className:"message-reactions",children:Object.entries(o).map(e=>{let[r,o]=e,l="reaction-".concat(t,"-").concat(r);b.current[r]||(b.current[r]=s.createRef());let i=N(r,o);return(0,n.jsx)(s.Fragment,{children:(0,n.jsxs)(d.z,{ref:b.current[r],id:l,size:"sm",variant:o.includes(a)?"solid":"outline",color:o.includes(a)?"primary":"secondary",className:"reaction-badge",onClick:()=>R(r),onMouseEnter:()=>S(r),onMouseLeave:()=>S(r),"data-bs-toggle":"tooltip","data-bs-placement":"top",title:i,children:[(0,n.jsx)("span",{className:"reaction-emoji",children:r}),(0,n.jsx)("span",{className:"reaction-count",children:o.length})]})},r)})}):null,[o,t,a,p,R,S,N]),I=(0,s.useCallback)(e=>{e.stopPropagation(),g(e=>!e)},[]),T=(0,s.useCallback)(()=>{if(!j.current)return{top:0,left:0};let e=j.current.getBoundingClientRect();e.height;let t=e.top-350-15,r=e.left;return t<10&&(t=e.bottom+15),r+350>window.innerWidth&&(r=window.innerWidth-350-10),r<10&&(r=10),{top:t,left:r}},[]);return(0,n.jsxs)("div",{className:"flex flex-col ".concat(c?"items-end":"items-start"),ref:w,children:[E(),(0,n.jsx)("div",{className:"message-actions-wrapper ".concat(c?"mine":""),children:(0,n.jsxs)("div",{className:"message-actions",style:{display:"flex",alignItems:"center",gap:"var(--vapor-space-100)"},children:[(0,n.jsxs)("div",{style:{position:"relative"},children:[(0,n.jsx)(Z.h,{ref:j,size:"sm",variant:"outline",onClick:I,"aria-label":"리액션 추가",children:(0,n.jsx)(A.lME,{size:16})}),m&&q.createPortal((0,n.jsx)("div",{ref:x,style:{position:"fixed",...T(),zIndex:9999},onClick:e=>e.stopPropagation(),children:(0,n.jsx)("div",{className:"emoji-picker-container",style:{backgroundColor:"var(--vapor-color-normal)",borderRadius:"var(--vapor-radius-lg)",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",border:"1px solid var(--vapor-color-border)"},children:(0,n.jsx)(K,{onSelect:R,emojiSize:20,perLine:8,theme:"light"})})}),document.body)]}),(0,n.jsx)(Z.h,{size:"sm",variant:"outline",onClick:C,"aria-label":"메시지 복사",children:(0,n.jsx)(A.TIy,{size:16})})]})})]})};Y.defaultProps={messageId:"",messageContent:"",reactions:{},currentUserId:null,onReactionAdd:()=>{},onReactionRemove:()=>{},isMine:!1,room:null};let X=s.memo(Y),$=e=>{let{messageType:t="text",participants:r=[],readers:o=[],className:a="",socketRef:l=null,messageId:c=null,messageRef:u=null,currentUserId:d=null}=e,[m,g]=(0,s.useState)(o||[]),[p,h]=(0,s.useState)(!1),[f,v]=(0,s.useState)(!1),y=(0,s.useRef)(null),x=(0,s.useRef)(null),j=(0,s.useMemo)(()=>"system"===t?[]:r.filter(e=>{let t=e._id||e.id,r=!m.some(e=>e.userId===t),n=t!==d;return r&&n}),[r,m,d,t]),w=(0,s.useMemo)(()=>"system"===t?0:j.length,[j.length,t]),b=(0,s.useCallback)(async()=>{if(c&&d&&!f&&"system"!==t&&(null==l?void 0:l.current))try{l.current.emit("markMessagesAsRead",{messageIds:[c]}),v(!0),g(e=>e.some(e=>e.userId===d)?e:[...e,{userId:d,readAt:new Date}])}catch(e){console.error("Error marking message as read:",e)}},[c,d,f,t,l]);(0,s.useEffect)(()=>{if((null==u?void 0:u.current)&&d&&!f&&"system"!==t){if(m.some(e=>e.userId===d)){v(!0);return}return x.current=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!f&&b()})},{root:null,rootMargin:"0px",threshold:.5}),x.current.observe(u.current),()=>{x.current&&x.current.disconnect()}}},[u,d,f,t,m,b]),(0,s.useCallback)(()=>{if(0===w)return"모두 읽음";let e=j.map(e=>e.name);return"".concat(e.join(", "),"이 읽지 않음")},[w,j]);let k=(0,s.useCallback)(e=>{let{userId:t,messageIds:r,timestamp:n}=e;c&&r.includes(c)&&g(e=>e.some(e=>e.userId===t)?e:[...e,{userId:t,readAt:n||new Date}])},[c]),C=(0,s.useCallback)(e=>{g(t=>t.filter(t=>e.some(e=>e._id===t.userId||e.id===t.userId)))},[]);return((0,s.useEffect)(()=>{g(o)},[o]),(0,s.useEffect)(()=>{if(null==l?void 0:l.current)return l.current.on("messagesRead",k),l.current.on("participantsUpdate",C),()=>{l.current&&(l.current.off("messagesRead",k),l.current.off("participantsUpdate",C))}},[l,k,C]),"system"===t)?null:0===w?(0,n.jsx)("div",{className:"read-status ".concat(a),ref:y,role:"status","aria-label":"모든 참여자가 메시지를 읽었습니다",children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,n.jsx)(A.NX7,{size:12,style:{color:"var(--vapor-color-success)"}}),(0,n.jsx)(A.NX7,{size:12,style:{color:"var(--vapor-color-success)",marginLeft:"-6px"}})]}),(0,n.jsx)(i.x,{typography:"caption",style:{fontSize:"0.65rem",color:"var(--vapor-color-text-muted)"},children:"모두 읽음"})]})}):(0,n.jsx)("div",{className:"read-status ".concat(a),ref:y,role:"status","aria-label":"".concat(w,"명이 메시지를 읽지 않았습니다"),children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsx)(A.NX7,{size:12,style:{color:"var(--vapor-color-gray-400)"}}),w>0&&(0,n.jsxs)(i.x,{typography:"caption",style:{fontSize:"0.65rem",color:"var(--vapor-color-text-muted)"},children:[w,"명 안 읽음"]})]})})};$.displayName="ReadStatus";let J=s.memo($);var V=r(21876).Buffer;let G=e=>{var t;let{msg:r={},isMine:o=!1,currentUser:a=null,onReactionAdd:l,onReactionRemove:c,room:m=null,messageRef:g,socketRef:p}=e,[h,v]=(0,s.useState)(null),[y,x]=(0,s.useState)("");if((0,s.useEffect)(()=>{if(null==r?void 0:r.file){let e=b.getPreviewUrl(r.file,!0);x(e),console.debug("Preview URL generated:",{filename:r.file.filename,url:e})}},[null==r?void 0:r.file]),!(null==r?void 0:r.file))return console.error("File data is missing:",r),null;let j=new Date(r.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),w=()=>{var e;let t=(null===(e=r.file)||void 0===e?void 0:e.mimetype)||"",s={className:"w-5 h-5 flex-shrink-0"};return t.startsWith("image/")?(0,n.jsx)(A.XBm,{...s,color:"#00C853"}):t.startsWith("video/")?(0,n.jsx)(A.HiY,{...s,color:"#2196F3"}):t.startsWith("audio/")?(0,n.jsx)(A.IbZ,{...s,color:"#9C27B0"}):(0,n.jsx)(A.p5_,{...s,color:"#ffffff"})},k=e=>{try{if(!e)return"Unknown File";let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=t.length%4,n=r?t+"=".repeat(4-r):t;if(n.match(/^[A-Za-z0-9+/=]+$/))return V.from(n,"base64").toString("utf8");return decodeURIComponent(e)}catch(t){return console.error("Filename decoding error:",t),e}},C=async e=>{e.preventDefault(),e.stopPropagation(),v(null);try{var t;if(!(null===(t=r.file)||void 0===t?void 0:t.filename))throw Error("파일 정보가 없습니다.");let e=f.Z.getCurrentUser();if(!(null==e?void 0:e.token)||!(null==e?void 0:e.sessionId))throw Error("인증 정보가 없습니다.");let n=b.getFileUrl(r.file.filename,!1),s="".concat(n,"?token=").concat(encodeURIComponent(e.token),"&sessionId=").concat(encodeURIComponent(e.sessionId),"&download=true"),o=document.createElement("a");o.href=s,o.download=k(r.file.originalname),document.body.appendChild(o),o.click(),document.body.removeChild(o)}catch(e){console.error("File download error:",e),v(e.message||"파일 다운로드 중 오류가 발생했습니다.")}},R=e=>{e.preventDefault(),e.stopPropagation(),v(null);try{var t;if(!(null===(t=r.file)||void 0===t?void 0:t.filename))throw Error("파일 정보가 없습니다.");let e=f.Z.getCurrentUser();if(!(null==e?void 0:e.token)||!(null==e?void 0:e.sessionId))throw Error("인증 정보가 없습니다.");let n=b.getFileUrl(r.file.filename,!0),s="".concat(n,"?token=").concat(encodeURIComponent(e.token),"&sessionId=").concat(encodeURIComponent(e.sessionId)),o=window.open(s,"_blank");if(!o)throw Error("팝업이 차단되었습니다. 팝업 차단을 해제해주세요.");o.opener=null}catch(e){console.error("File view error:",e),v(e.message||"파일 보기 중 오류가 발생했습니다.")}},S=e=>{try{var t;if(!(null==r?void 0:null===(t=r.file)||void 0===t?void 0:t.filename))return(0,n.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-100",children:(0,n.jsx)(A.XBm,{className:"w-8 h-8 text-gray-400"})});let s=f.Z.getCurrentUser();if(!(null==s?void 0:s.token)||!(null==s?void 0:s.sessionId))throw Error("인증 정보가 없습니다.");let o=b.getPreviewUrl(r.file,!0);return(0,n.jsx)("div",{className:"bg-transparent-pattern",children:(0,n.jsx)("img",{src:o,alt:e,className:"object-cover rounded-sm",onLoad:()=>{console.debug("Image loaded successfully:",e)},onError:t=>{console.error("Image load error:",{error:t.error,originalname:e}),t.target.onerror=null,t.target.src="/images/placeholder-image.png",v("이미지를 불러올 수 없습니다.")},loading:"lazy"})})}catch(e){return console.error("Image preview error:",e),v(e.message||"이미지 미리보기를 불러올 수 없습니다."),(0,n.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-100",children:(0,n.jsx)(A.XBm,{className:"w-8 h-8 text-gray-400"})})}};return(0,n.jsx)("div",{className:"messages",children:(0,n.jsxs)("div",{className:"message-group ".concat(o?"mine":"yours"),children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(U.Z,{user:o?a:r.sender,size:"md",className:"flex-shrink-0",showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:o?"나":null===(t=r.sender)||void 0===t?void 0:t.name})]}),(0,n.jsxs)("div",{className:"message-bubble ".concat(o?"message-mine":"message-other"," last file-message"),children:[(0,n.jsxs)("div",{className:"message-content",children:[h&&(0,n.jsxs)(u.U,{color:"danger",className:"mb-3 d-flex align-items-center",children:[(0,n.jsx)(A.oC6,{className:"w-4 h-4 me-2"}),(0,n.jsx)("span",{children:h}),(0,n.jsx)(d.z,{variant:"ghost",size:"sm",className:"ms-auto","aria-label":"Close",onClick:()=>v(null),children:"x"})]}),(()=>{var e,t,s;let o=(null===(e=r.file)||void 0===e?void 0:e.mimetype)||"",a=k((null===(t=r.file)||void 0===t?void 0:t.originalname)||"Unknown File"),l=b.formatFileSize((null===(s=r.file)||void 0===s?void 0:s.size)||0);console.log("✅",o,a,l);let c=()=>(0,n.jsxs)("div",{className:"file-actions mt-2 pt-2 border-t border-gray-200",children:[(0,n.jsxs)(d.z,{size:"sm",variant:"outline",onClick:R,title:"새 탭에서 보기",children:[(0,n.jsx)(A.nK8,{size:16}),(0,n.jsx)("span",{children:"새 탭에서 보기"})]}),(0,n.jsxs)(d.z,{size:"sm",variant:"outline",onClick:C,title:"다운로드",children:[(0,n.jsx)(A._8t,{size:16}),(0,n.jsx)("span",{children:"다운로드"})]})]}),u="overflow-hidden",m="flex items-center gap-3 p-1 mt-2";return o.startsWith("image/")?(0,n.jsxs)("div",{className:u,children:[S(a),(0,n.jsx)("div",{className:m,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",a]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:l})]})}),(0,n.jsx)(c,{})]}):o.startsWith("video/")?(0,n.jsxs)("div",{className:u,children:[(0,n.jsx)("div",{children:y?(0,n.jsxs)("video",{className:"object-cover rounded-sm",controls:!0,preload:"metadata","aria-label":"".concat(a," 비디오"),crossOrigin:"use-credentials",children:[(0,n.jsx)("source",{src:y,type:o}),(0,n.jsx)("track",{kind:"captions"}),"비디오를 재생할 수 없습니다."]}):(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsx)(A.HiY,{className:"w-8 h-8 text-gray-400"})})}),(0,n.jsx)("div",{className:m,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",a]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:l})]})}),(0,n.jsx)(c,{})]}):o.startsWith("audio/")?(0,n.jsxs)("div",{className:u,children:[(0,n.jsx)("div",{className:m,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",a]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:l})]})}),(0,n.jsx)("div",{className:"px-3 pb-3",children:y&&(0,n.jsxs)("audio",{className:"w-full",controls:!0,preload:"metadata","aria-label":"".concat(a," 오디오"),crossOrigin:"use-credentials",children:[(0,n.jsx)("source",{src:y,type:o}),"오디오를 재생할 수 없습니다."]})}),(0,n.jsx)(c,{})]}):(0,n.jsxs)("div",{className:u,children:[(0,n.jsx)("div",{className:m,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)("div",{className:"font-medium truncate",children:[w()," ",a]}),(0,n.jsx)(i.x,{typography:"body2",as:"span",children:l})]})}),(0,n.jsx)(c,{})]})})(),r.content&&(0,n.jsx)("div",{className:"mt-3",children:(0,n.jsx)(O,{content:r.content})})]}),(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",title:new Date(r.timestamp).toLocaleString("ko-KR"),children:j}),(0,n.jsx)(J,{messageType:r.type,participants:m.participants,readers:r.readers,messageId:r._id,messageRef:g,currentUserId:a.id,socketRef:p})]})]}),(0,n.jsx)(X,{messageId:r._id,messageContent:r.content,reactions:r.reactions,currentUserId:null==a?void 0:a.id,onReactionAdd:l,onReactionRemove:c,isMine:o,room:m})]})})};G.defaultProps={msg:{file:{mimetype:"",filename:"",originalname:"",size:0}},isMine:!1,currentUser:null};let Q=s.memo(G);var ee=r(6969);let et=e=>{var t,r;let{msg:o={},isMine:a=!1,currentUser:l=null,onReactionAdd:i,onReactionRemove:c,room:u=null,messageRef:d,socketRef:m}=e,g=new Date(o.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),p=(0,s.useMemo)(()=>{var e;let t=a?null==l?void 0:l.email:null===(e=o.sender)||void 0===e?void 0:e.email;if(!t)return{};let r=(0,ee.FV)(t),n=(0,ee.pJ)(r);return{backgroundColor:r,color:n}},[a,null==l?void 0:l.email,null===(t=o.sender)||void 0===t?void 0:t.email]),h=a?l:o.sender;return(0,n.jsx)("div",{className:"messages",children:(0,n.jsxs)("div",{className:"message-group ".concat(a?"mine":"yours"),children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(U.Z,{user:h,size:"lg",style:p,showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:a?"나":null===(r=o.sender)||void 0===r?void 0:r.name})]}),(0,n.jsxs)("div",{className:"message-bubble ".concat(a?"message-mine":"message-other"," last relative group"),children:[(0,n.jsx)("div",{className:"message-content",children:(0,n.jsx)(O,{content:o.content})}),(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",children:g}),(0,n.jsx)(J,{messageType:o.type,participants:u.participants,readers:o.readers,messageId:o._id,messageRef:d,currentUserId:l.id,socketRef:m})]})]}),(0,n.jsx)(X,{messageId:o._id,messageContent:o.content,reactions:o.reactions,currentUserId:null==l?void 0:l.id,onReactionAdd:i,onReactionRemove:c,isMine:a,room:u})]})})};et.defaultProps={msg:{},isMine:!1,currentUser:null,onReactionAdd:()=>{},onReactionRemove:()=>{},room:null};let er=s.memo(et),en=e=>{let{msg:t={},isStreaming:r=!1,isMine:s=!1,currentUser:o=null,onReactionAdd:a,onReactionRemove:l,room:i=null,messageRef:c,socketRef:u}=e,d=new Date(t.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),m={name:"wayneAI"===t.aiType?"Wayne AI":"Consulting AI",email:"wayneAI"===t.aiType?"ai@wayne.ai":"ai@consulting.ai",avatarInitial:"wayneAI"===t.aiType?"W":"C"};return(0,n.jsxs)("div",{className:"message-group yours",children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(U.Z,{user:m,size:"lg",showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:m.name})]}),(0,n.jsxs)("div",{className:"message-bubble message-ai last relative group",children:[(0,n.jsx)("div",{className:"message-content",children:r?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(O,{content:t.content}),(0,n.jsxs)("div",{className:"typing-indicator",children:[(0,n.jsx)("span",{}),(0,n.jsx)("span",{}),(0,n.jsx)("span",{})]})]}):(0,n.jsx)(O,{content:t.content})}),!r&&(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",children:d}),(0,n.jsx)(J,{messageType:t.type,participants:i.participants,readers:t.readers,messageId:t._id,messageRef:c,currentUserId:o.id,socketRef:u})]})]}),(0,n.jsx)(X,{messageId:t._id,messageContent:t.content,reactions:t.reactions,currentUserId:null==o?void 0:o.id,onReactionAdd:a,onReactionRemove:l,isMine:s,room:i})]})};en.defaultProps={msg:{},isStreaming:!1,currentUser:null,onReactionAdd:()=>{},onReactionRemove:()=>{},room:null};let es=s.memo(en);class eo{logDebug(e,t){console.debug("[ScrollHandler] ".concat(e,":"),{...t,timestamp:new Date().toISOString()})}saveScrollPosition(){let e=this.containerRef.current;e&&(this.logDebug("saveScrollPosition",{scrollHeight:e.scrollHeight,scrollTop:e.scrollTop}),this.scrollHeightBeforeLoadRef.current=e.scrollHeight,this.scrollTopBeforeLoadRef.current=e.scrollTop,this.isLoadingOldMessages.current=!0)}async startLoadingMessages(){return this.isLoadingRef.current||this.loadMoreTriggeredRef.current?(this.logDebug("startLoadingMessages prevented",{isLoading:this.isLoadingRef.current,loadMoreTriggered:this.loadMoreTriggeredRef.current}),!1):(this.saveScrollPosition(),this.isLoadingRef.current=!0,this.loadMoreTriggeredRef.current=!0,!0)}restoreScrollPosition(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=this.containerRef.current;if(t&&this.isLoadingOldMessages.current)try{this.isRestoringScroll.current=!0,this.temporaryDisableScroll.current=!0;let r=t.scrollHeight,n=r-this.scrollHeightBeforeLoadRef.current,s=this.scrollTopBeforeLoadRef.current+n;if(this.logDebug("restoreScrollPosition",{newScrollHeight:r,heightDifference:n,newScrollTop:s,immediate:e}),e){let e=t.style.scrollBehavior;t.style.scrollBehavior="auto",t.scrollTop=s,requestAnimationFrame(()=>{t.style.scrollBehavior=e,this.temporaryDisableScroll.current=!1,this.isRestoringScroll.current=!1})}else t.scrollTo({top:s,behavior:"smooth"}),this.temporaryDisableScroll.current=!1,this.isRestoringScroll.current=!1}finally{this.resetScrollState()}}resetScrollState(){this.scrollHeightBeforeLoadRef.current=0,this.scrollTopBeforeLoadRef.current=0,this.isLoadingOldMessages.current=!1,this.isLoadingRef.current=!1,this.loadMoreTriggeredRef.current=!1,setTimeout(()=>{this.isRestoringScroll.current=!1,this.temporaryDisableScroll.current=!1},100)}shouldScrollToBottom(e,t){return!this.isLoadingOldMessages.current&&!this.isRestoringScroll.current&&(t||this.isNearBottom.current)}updateScrollPosition(){let e=this.containerRef.current;if(!e)return null;let{scrollTop:t,scrollHeight:r,clientHeight:n}=e;this.isNearBottom.current=r-t-n<100;let s={isAtTop:t<this.SCROLL_THRESHOLD,isAtBottom:this.isNearBottom.current,scrollTop:t,scrollHeight:r,clientHeight:n};return this.logDebug("updateScrollPosition",s),s}async handleScroll(e,t){let{hasMoreMessages:r,loadingMessages:n,onLoadMore:s,onScrollPositionChange:o,onScroll:a}=t;if(this.temporaryDisableScroll.current||this.isRestoringScroll.current){this.logDebug("handleScroll skipped",{temporaryDisableScroll:this.temporaryDisableScroll.current,isRestoringScroll:this.isRestoringScroll.current});return}let l=this.updateScrollPosition();l&&(this.scrollTimeoutRef.current&&clearTimeout(this.scrollTimeoutRef.current),this.scrollTimeoutRef.current=setTimeout(async()=>{if(l.isAtTop&&r&&!n&&(this.logDebug("handleScroll loadMore",{isAtTop:l.isAtTop,hasMoreMessages:r,loadingMessages:n}),await this.startLoadingMessages()))try{await s()}catch(e){console.error("Load more error:",e),this.resetScrollState()}null==o||o(l),null==a||a(l)},this.SCROLL_DEBOUNCE_DELAY))}scrollToBottom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";if(this.isLoadingOldMessages.current||this.isRestoringScroll.current)return;let t=this.containerRef.current;t&&requestAnimationFrame(()=>{try{let r=t.scrollHeight,n=t.clientHeight,s=r-n;t.scrollTo({top:s,behavior:e}),this.logDebug("scrollToBottom",{scrollHeight:r,height:n,maxScrollTop:s,behavior:e})}catch(e){console.error("Scroll to bottom error:",e),t.scrollTop=t.scrollHeight}})}cleanup(){this.scrollTimeoutRef.current&&clearTimeout(this.scrollTimeoutRef.current),this.scrollRestorationRef.current&&cancelAnimationFrame(this.scrollRestorationRef.current)}constructor(e){this.containerRef=e,this.scrollHeightBeforeLoadRef={current:0},this.scrollTopBeforeLoadRef={current:0},this.isLoadingOldMessages={current:!1},this.isRestoringScroll={current:!1},this.isNearBottom={current:!0},this.scrollTimeoutRef={current:null},this.scrollRestorationRef={current:null},this.temporaryDisableScroll={current:!1},this.scrollBehavior={current:"smooth"},this.isLoadingRef={current:!1},this.loadMoreTriggeredRef={current:!1},this.SCROLL_THRESHOLD=30,this.SCROLL_DEBOUNCE_DELAY=100}}let ea=s.memo(e=>{let{text:t}=e;return(0,n.jsxs)("div",{className:"loading-messages",children:[(0,n.jsx)("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("span",{className:"text-secondary text-sm",children:t})]})});ea.displayName="LoadingIndicator";let el=s.memo(()=>(0,n.jsx)("div",{className:"message-history-end",children:(0,n.jsx)("span",{className:"text-secondary text-sm",children:"더 이상 불러올 메시지가 없습니다."})}));el.displayName="MessageHistoryEnd";let ei=s.memo(()=>(0,n.jsxs)("div",{className:"empty-messages",children:[(0,n.jsx)(i.x,{typography:"body1",children:"아직 메시지가 없습니다."}),(0,n.jsx)(i.x,{typography:"body2",color:"neutral-weak",children:"첫 메시지를 보내보세요!"})]}));ei.displayName="EmptyMessages";let ec=e=>{let{messages:t=[],streamingMessages:r={},currentUser:o=null,room:a=null,loadingMessages:l=!1,hasMoreMessages:i=!0,onScroll:c=()=>{},onLoadMore:u=()=>{},onReactionAdd:d=()=>{},onReactionRemove:m=()=>{},messagesEndRef:g,socketRef:p,scrollToBottomOnNewMessage:h=!0,onScrollPositionChange:f=()=>{}}=e,v=(0,s.useRef)(null),y=(0,s.useRef)(null),x=(0,s.useRef)(!1),j=(0,s.useRef)(t.length),w=(0,s.useRef)(!0),b=(0,s.useRef)(null),k=(0,s.useRef)(new eo(v));console.log("messages: ",t),(0,s.useCallback)((e,r)=>{console.debug("[ChatMessages] ".concat(e,":"),{...r,loadingMessages:l,hasMoreMessages:i,isLoadingOldMessages:k.current.isLoadingOldMessages.current,messageCount:t.length,timestamp:new Date().toISOString(),isInitialLoad:w.current})},[l,i,t.length]);let C=(0,s.useCallback)(e=>null!=e&&!!e.sender&&null!=o&&!!o.id&&(e.sender._id===o.id||e.sender.id===o.id||e.sender===o.id),[null==o?void 0:o.id]),R=(0,s.useCallback)(e=>{k.current.handleScroll(e,{hasMoreMessages:i,loadingMessages:l,onLoadMore:u,onScrollPositionChange:f,onScroll:c})},[i,l,u,f,c]);(0,s.useLayoutEffect)(()=>{if(t.length>j.current){let e=t.slice(j.current),r=e[e.length-1];h&&k.current.shouldScrollToBottom(r,C(r))&&k.current.scrollToBottom("smooth"),j.current=t.length}},[t,h,C]),(0,s.useLayoutEffect)(()=>{!l&&k.current.isLoadingOldMessages.current&&(k.current.scrollRestorationRef.current&&cancelAnimationFrame(k.current.scrollRestorationRef.current),k.current.scrollRestorationRef.current=requestAnimationFrame(()=>{k.current.restoreScrollPosition(!0)}))},[l]),(0,s.useEffect)(()=>{let e=Object.values(r);if(e.length>0){let t=e[e.length-1];t&&k.current.shouldScrollToBottom(t,C(t))&&k.current.scrollToBottom("smooth")}},[r,C]),(0,s.useLayoutEffect)(()=>{!x.current&&t.length>0&&(k.current.scrollToBottom("auto"),x.current=!0,w.current&&setTimeout(()=>{w.current=!1},1e3))},[t.length]),(0,s.useEffect)(()=>{let e=v.current;if(e)return e.addEventListener("scroll",R,{passive:!0}),()=>{k.current.cleanup(),b.current&&clearTimeout(b.current),e.removeEventListener("scroll",R)}},[R]);let S=(0,s.useMemo)(()=>Array.isArray(t)?[...t,...Object.values(r||{})].sort((e,t)=>(null==e?void 0:e.timestamp)&&(null==t?void 0:t.timestamp)?new Date(e.timestamp)-new Date(t.timestamp):0):[],[t,r]),N=(0,s.useCallback)((e,t)=>{if(!e||!M||!Q||!er||!es)return console.error("Message component undefined:",{msgType:null==e?void 0:e.type,hasSystemMessage:!!M,hasFileMessage:!!Q,hasUserMessage:!!er,hasAIMessage:!!es}),null;let r=t===S.length-1;console.log("✅msg.type:",e.type);let s={system:M,file:Q,ai:es}[e.type]||er;return"file"===e.type&&console.log("✅msg.component:",s),(0,n.jsx)(s,{ref:r?y:null,currentUser:o,room:a,onReactionAdd:d,onReactionRemove:m,msg:e,content:e.content,isMine:"system"!==e.type?C(e):void 0,isStreaming:"ai"===e.type?e.isStreaming||!1:void 0,messageRef:e,socketRef:p},e._id||"msg-".concat(t))},[S.length,o,a,C,d,m,p]);return(0,n.jsxs)("div",{className:"message-list",ref:v,role:"log","aria-live":"polite","aria-atomic":"false",children:[l&&(0,n.jsx)(ea,{text:"이전 메시지를 불러오는 중..."}),!l&&!i&&t.length>0&&(0,n.jsx)(el,{}),0===S.length?(0,n.jsx)(ei,{}):S.map((e,t)=>N(e,t))]})};ec.displayName="ChatMessages";let eu=s.memo(ec),ed=e=>{let{onAction:t,className:r="",size:o="xs"}=e,a=navigator.platform.toUpperCase().indexOf("MAC")>=0,l=a?"⌘":"Ctrl",i=[{id:"bold",icon:A.hlZ,markdown:"**",tooltip:"굵게",shortcut:"".concat(l,"+B"),keyBinding:{key:"b",modifier:!0}},{id:"italic",icon:A.h32,markdown:"_",tooltip:"기울임",shortcut:"".concat(l,"+I"),keyBinding:{key:"i",modifier:!0}},{id:"inline-code",icon:A.MMM,markdown:"`",tooltip:"인라인 코드",shortcut:"".concat(l,"+`"),keyBinding:{key:"`",modifier:!0}},{id:"code-block",icon:A.VER,markdown:"```\n\n```",tooltip:"코드 블록",shortcut:"".concat(l,"+Shift+C"),keyBinding:{key:"c",modifier:!0,shift:!0}},{id:"bullet-list",icon:A.Rag,markdown:"- ",tooltip:"글머리 기호",shortcut:"".concat(l,"+U"),keyBinding:{key:"u",modifier:!0}},{id:"numbered-list",icon:A.yPu,markdown:"1. ",tooltip:"번호 매기기",shortcut:"".concat(l,"+O"),keyBinding:{key:"o",modifier:!0}},{id:"quote",icon:A.NfN,markdown:"> ",tooltip:"인용",shortcut:"".concat(l,"+Q"),keyBinding:{key:"q",modifier:!0}},{id:"heading",icon:A.R5E,markdown:"## ",tooltip:"제목",shortcut:"".concat(l,"+H"),keyBinding:{key:"h",modifier:!0}},{id:"link",icon:A.usw,markdown:"[](url)",tooltip:"링크",shortcut:"".concat(l,"+K"),keyBinding:{key:"k",modifier:!0}}],c=(0,s.useCallback)(e=>{let r=a?e.metaKey:e.ctrlKey,n=i.find(t=>{let n=t.keyBinding;return n.key===e.key.toLowerCase()&&n.modifier===r&&(!n.shift||n.shift===e.shiftKey)});n&&(e.preventDefault(),t(n.markdown))},[t,a,i]);s.useEffect(()=>(document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}),[c]);let u=e=>{let{action:r}=e,s=r.icon;return(0,n.jsx)(Z.h,{variant:"ghost",size:"md",onClick:()=>t(r.markdown),"aria-label":"".concat(r.tooltip," (").concat(r.shortcut,")"),title:"".concat(r.tooltip," (").concat(r.shortcut,")"),children:(0,n.jsx)(s,{size:20})})};return(0,n.jsx)("div",{className:"markdown-toolbar ".concat(r),children:(0,n.jsx)(g.Ug,{gap:"050",role:"group","aria-label":"Markdown toolbar",children:i.map(e=>(0,n.jsx)(u,{action:e},e.id))})})},em=(0,s.memo)(e=>{let{participants:t=[],activeIndex:r=0,onSelect:o=()=>{},onMouseEnter:a=()=>{}}=e,i=(0,s.useRef)(null),c=(0,s.useRef)([]);(0,s.useEffect)(()=>{if(!i.current||!c.current[r])return;let e=i.current,t=c.current[r],n=t.offsetTop,s=n+t.offsetHeight,o=e.scrollTop,a=o+e.offsetHeight;n<o?e.scrollTo({top:n,behavior:"smooth"}):s>a&&e.scrollTo({top:s-e.offsetHeight,behavior:"smooth"})},[r]);let u=(0,s.useCallback)(e=>{if(!e)return{};if(e.isAI){let t=(0,ee.eK)(e.name);return{backgroundColor:t.backgroundColor,color:t.color,boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)"}}let t=(0,ee.FV)(e.email),r=(0,ee.pJ)(t);return{backgroundColor:t,color:r,boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"}},[]),d=(0,s.useCallback)(e=>e.isAI?(0,n.jsx)("span",{className:"mention-badge ai",children:"AI 어시스턴트"}):(0,n.jsx)("span",{className:"mention-badge user",title:e.email,children:e.email}),[]),m=(0,s.useCallback)(e=>e.isAI?"wayneAI"===e.name?"W":"C":e.name.charAt(0).toUpperCase(),[]),g=(0,s.useCallback)((e,t)=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),o(t))},[o]);return(null==t?void 0:t.length)?(0,n.jsx)("div",{className:"mention-dropdown",role:"listbox","aria-label":"멘션할 사용자 목록",ref:i,children:t.map((e,t)=>(0,n.jsx)("div",{ref:e=>c.current[t]=e,role:"option","aria-selected":t===r,tabIndex:0,className:"mention-item ".concat(t===r?"active":""),onClick:()=>o(e),onKeyDown:t=>g(t,e),onMouseEnter:()=>a(t),children:(0,n.jsxs)("div",{className:"mention-item-content",children:[(0,n.jsx)(l.qE.Root,{size:"sm",style:{...u(e),flexShrink:0},"aria-label":"".concat(e.name,"의 아바타"),children:(0,n.jsx)(l.qE.Fallback,{style:u(e),children:m(e)})}),(0,n.jsxs)("div",{className:"mention-info",children:[(0,n.jsx)("span",{className:"mention-name",children:e.isAI?"wayneAI"===e.name?"Wayne AI":"Consulting AI":e.name}),d(e)]})]})},e._id||"ai-".concat(e.name)))}):null}),eg=e=>{let{files:t=[],uploading:r=!1,uploadProgress:o=0,uploadError:a=null,onRemove:l,onRetry:i,onDrop:c,className:m="",showFileName:g=!0,showFileSize:p=!0,variant:h="default",previewSize:f="md",allowPaste:v=!0,maxFiles:y=10}=e,x=(0,s.useRef)(null),j=(0,s.useRef)(new Map),w=(0,s.useRef)(0);(0,s.useEffect)(()=>()=>{j.current.forEach(e=>{URL.revokeObjectURL(e)}),j.current.clear()},[]);let k=(0,s.useCallback)(async e=>{try{await b.validateFile(e);let t={file:e,name:e.name||"file-".concat(Date.now(),".").concat(e.type.split("/")[1]),type:e.type,size:e.size},r=URL.createObjectURL(e);return j.current.set(t.name,r),t}catch(e){throw console.error("File processing error:",e),e}},[]);(0,s.useEffect)(()=>{if(!v)return;let e=async e=>{var r,n;if(!(null===(r=x.current)||void 0===r?void 0:r.contains(e.target))||t.length>=y)return;let s=null===(n=e.clipboardData)||void 0===n?void 0:n.items;if(!s)return;let o=Array.from(s).filter(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(0===o.length)return;e.preventDefault();let a=y-t.length;for(let e of o.slice(0,a)){let t=e.getAsFile();if(t)try{let e=await k(t);null==c||c(e)}catch(e){console.error("Paste handling error:",e)}}};return document.addEventListener("paste",e),()=>document.removeEventListener("paste",e)},[v,t.length,y,c,k]),(0,s.useEffect)(()=>{if(!x.current||!c)return;let e=async e=>{if(e.preventDefault(),e.stopPropagation(),w.current=0,x.current.classList.remove("drag-over"),t.length>=y)return;let r=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type);if(0===r.length)return;let n=y-t.length;for(let e of r.slice(0,n))try{let t=await k(e);c(t)}catch(e){console.error("Drop handling error:",e)}},r=e=>{e.preventDefault(),e.stopPropagation(),t.length<y&&x.current.classList.add("drag-over")},n=e=>{e.preventDefault(),e.stopPropagation(),w.current++,1===w.current&&t.length<y&&x.current.classList.add("drag-over")},s=e=>{e.preventDefault(),e.stopPropagation(),w.current--,0===w.current&&x.current.classList.remove("drag-over")},o=x.current;return o.addEventListener("drop",e),o.addEventListener("dragover",r),o.addEventListener("dragenter",n),o.addEventListener("dragleave",s),()=>{o.removeEventListener("drop",e),o.removeEventListener("dragover",r),o.removeEventListener("dragenter",n),o.removeEventListener("dragleave",s)}},[t.length,y,c,k]);let C=(0,s.useCallback)(e=>{let t={size:"compact"===h?20:24,className:"file-icon","aria-hidden":!0};return e.type.startsWith("image/")?(0,n.jsx)(A.XBm,{...t,color:"#00C853"}):e.type.startsWith("video/")?(0,n.jsx)(A.HiY,{...t,color:"#2196F3"}):e.type.startsWith("audio/")?(0,n.jsx)(A.MusicIcon,{...t,color:"#9C27B0"}):"application/pdf"===e.type?(0,n.jsx)(A.p5_,{...t,color:"#F44336"}):(0,n.jsx)(A.aAW,{...t,color:"#757575"})},[h]),R=(0,s.useCallback)(e=>{let t=j.current.get(e.name),r="rounded-lg overflow-hidden relative";return e.type.startsWith("image/")?(0,n.jsx)("div",{className:"".concat(r," ").concat("bg-transparent-pattern"),children:(0,n.jsx)("img",{src:t||e.url,alt:"".concat(e.name," 미리보기"),className:"w-full h-full object-cover",onError:e=>{e.target.onerror=null,e.target.src="/placeholder-image.png",e.target.alt="이미지 로드 실패"},loading:"lazy"})}):e.type.startsWith("video/")?(0,n.jsxs)("div",{className:"".concat(r),children:[(0,n.jsxs)("video",{src:t||e.url,className:"w-full h-full object-cover",controls:"compact"!==h,controlsList:"nodownload",preload:"metadata","aria-label":"".concat(e.name," 비디오 미리보기"),children:[(0,n.jsx)("source",{src:t||e.url,type:e.type}),(0,n.jsx)("track",{kind:"captions"}),"비디오 미리보기를 지원하지 않는 브라우저입니다."]}),(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-30",children:C(e)})]}):(0,n.jsxs)("div",{className:"".concat(r," flex flex-col items-center justify-center"),role:"img","aria-label":"".concat(e.name," 파일 아이콘"),children:[C(e),g&&(0,n.jsx)("span",{className:"mt-2 text-xs text-gray-600 truncate max-w-[80px]",children:e.type.split("/")[1].toUpperCase()})]})},[h,g,C]),S=(0,s.useCallback)(()=>a?(0,n.jsxs)(u.U,{color:"danger",className:"mt-2 flex items-center gap-2",children:[(0,n.jsx)(A.oC6,{className:"w-4 h-4","aria-hidden":"true"}),(0,n.jsx)("span",{className:"flex-1",children:a}),i&&(0,n.jsx)(d.z,{size:"sm",variant:"outline",onClick:i,children:"다시 시도"})]}):r?(0,n.jsxs)("div",{className:"mt-2 flex items-center gap-2 text-sm text-gray-600",children:[(0,n.jsx)(A.LoadingOutlineIcon,{className:"w-4 h-4 animate-spin","aria-hidden":"true"}),(0,n.jsxs)("span",{children:[o,"% 업로드 중..."]})]}):null,[a,r,o,i]);return 0===t.length?null:(0,n.jsxs)("div",{ref:x,className:"file-preview-scroll-container ".concat(m," ").concat(c?"cursor-pointer":""),role:"region","aria-label":"파일 미리보기",children:[(0,n.jsx)("div",{className:"file-preview-list",children:t.map((e,t)=>(0,n.jsx)("div",{className:"file-preview-item",children:(0,n.jsxs)("div",{className:"file-preview-content",children:[R(e),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[g&&(0,n.jsx)("div",{className:"text-sm font-medium truncate",title:e.name,children:e.name}),p&&(0,n.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:b.formatFileSize(e.size)})]}),"readonly"!==h&&(0,n.jsx)("div",{className:"flex-shrink-0",children:!r&&l&&(0,n.jsx)(Z.h,{size:"sm",variant:"outline",onClick:()=>{let t=j.current.get(e.name);t&&(URL.revokeObjectURL(t),j.current.delete(e.name)),l(e)},title:"".concat(e.name," 파일 제거"),"aria-label":"".concat(e.name," 파일 제거"),children:(0,n.jsx)(A.yNA,{className:"w-4 h-4","aria-hidden":"true"})})})]})},"".concat(e.name,"-").concat(t)))}),r?(0,n.jsx)("div",{className:"mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden",role:"progressbar","aria-valuenow":o,"aria-valuemin":"0","aria-valuemax":"100",children:(0,n.jsx)("div",{className:"h-full bg-primary transition-all duration-300 ease-in-out",style:{width:"".concat(o,"%")}})}):null,S(),t.length>=y&&(0,n.jsxs)(u.U,{color:"warning",className:"file-limit-warning",children:[(0,n.jsx)(A.oC6,{className:"w-4 h-4","aria-hidden":"true"}),(0,n.jsxs)("span",{children:["파일은 최대 ",y,"개까지만 업로드할 수 있습니다."]})]}),c&&(0,n.jsx)("div",{className:"absolute inset-0 bg-primary/10 border-2 border-primary border-dashed rounded-lg opacity-0 pointer-events-none transition-opacity drag-over:opacity-100","aria-hidden":"true",children:(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-primary font-medium",children:"파일을 여기에 놓으세요"})})})]})};eg.defaultProps={files:[],uploading:!1,uploadProgress:0,uploadError:null,showFileName:!0,showFileSize:!0,previewSize:"md",variant:"default",allowPaste:!0,maxFiles:10};let ep=(0,s.memo)(eg),eh=(0,s.forwardRef)((e,t)=>{let{message:r="",onMessageChange:o=()=>{},onSubmit:a=()=>{},onEmojiToggle:l=()=>{},onFileSelect:i=()=>{},fileInputRef:c,disabled:u=!1,uploading:m=!1,showEmojiPicker:p=!1,showMentionList:h=!1,mentionFilter:f="",mentionIndex:v=0,getFilteredParticipants:y=()=>[],setMessage:x=()=>{},setShowEmojiPicker:j=()=>{},setShowMentionList:w=()=>{},setMentionFilter:k=()=>{},setMentionIndex:C=()=>{},room:R=null}=e,S=(0,s.useRef)(null),N=(0,s.useRef)(null),E=(0,s.useRef)(null),I=(0,s.useRef)(null),T=t||I,[L,M]=(0,s.useState)([]),[U,F]=(0,s.useState)(!1),[z,D]=(0,s.useState)(0),[P,_]=(0,s.useState)(null),[B,O]=(0,s.useState)(!1),[q,W]=(0,s.useState)({top:0,left:0}),H=(0,s.useCallback)(async e=>{if(e)try{await b.validateFile(e);let t={file:e,url:URL.createObjectURL(e),name:e.name,type:e.type,size:e.size};M(e=>[...e,t]),_(null),null==i||i(e)}catch(e){console.error("File validation error:",e),_(e.message)}finally{(null==c?void 0:c.current)&&(c.current.value="")}},[i]),Y=(0,s.useCallback)(e=>{M(t=>t.filter(t=>t.name!==e.name)),URL.revokeObjectURL(e.url),_(null),D(0)},[]),X=(0,s.useCallback)(async e=>{e.preventDefault(),e.stopPropagation(),O(!1);let t=Array.from(e.dataTransfer.files);if(0!==t.length)try{await H(t[0])}catch(e){console.error("File drop error:",e)}},[H]),$=(0,s.useCallback)(async e=>{if(null==e||e.preventDefault(),L.length>0)try{let e=L[0];if(!e||!e.file)throw Error("파일이 선택되지 않았습니다.");a({type:"file",content:r.trim(),fileData:e}),x(""),M([])}catch(e){console.error("File submit error:",e),_(e.message)}else r.trim()&&(a({type:"text",content:r.trim()}),x(""))},[L,r,a,x]);(0,s.useEffect)(()=>{let e=e=>{var t,r;!p||(null===(t=S.current)||void 0===t?void 0:t.contains(e.target))||(null===(r=N.current)||void 0===r?void 0:r.contains(e.target))||j(!1)},t=async e=>{var t,r;if(!(null==T?void 0:null===(t=T.current)||void 0===t?void 0:t.contains(e.target)))return;let n=null===(r=e.clipboardData)||void 0===r?void 0:r.items;if(!n)return;let s=Array.from(n).find(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(!s)return;let o=s.getAsFile();if(o)try{await H(o),e.preventDefault()}catch(e){console.error("File paste error:",e)}};return document.addEventListener("mousedown",e),document.addEventListener("paste",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("paste",t),L.forEach(e=>URL.revokeObjectURL(e.url))}},[p,j,L,T,H]);let J=(0,s.useCallback)((e,t)=>{let r=e.value.slice(0,t).split("\n"),n=r.length-1,s=r[n],o=document.createElement("div");o.style.position="absolute",o.style.visibility="hidden",o.style.whiteSpace="pre",o.style.font=window.getComputedStyle(e).font,o.style.fontSize=window.getComputedStyle(e).fontSize,o.style.fontFamily=window.getComputedStyle(e).fontFamily,o.style.fontWeight=window.getComputedStyle(e).fontWeight,o.style.letterSpacing=window.getComputedStyle(e).letterSpacing,o.style.textTransform=window.getComputedStyle(e).textTransform,o.textContent=s,document.body.appendChild(o);let a=o.offsetWidth;document.body.removeChild(o);let l=e.getBoundingClientRect(),i=window.getComputedStyle(e),c=parseInt(i.paddingLeft),u=parseInt(i.paddingTop),d=parseInt(i.lineHeight)||1.5*parseFloat(i.fontSize),m=e.scrollTop,g=l.left+c+a,p=l.top+u+n*d-m,h=window.innerWidth;return window.innerHeight,g+320>h&&(g=h-320-10),g<10&&(g=10),(p+=40)-250<10?p=l.top+u+(n+1)*d-m+2:p-=250,{top:p,left:g}},[]),V=(0,s.useCallback)(e=>{let t=e.target.value,r=e.target.selectionStart,n=t.slice(0,r),s=n.lastIndexOf("@"),a=e.target;a.style.height="auto";let l=15*parseFloat(getComputedStyle(document.documentElement).fontSize);if(a.scrollHeight>l?(a.style.height="".concat(l,"px"),a.style.overflowY="auto"):(a.style.height="".concat(a.scrollHeight,"px"),a.style.overflowY="hidden"),o(e),-1!==s){let e=n.slice(s+1);if(!e.includes(" ")){k(e.toLowerCase()),w(!0),C(0),W(J(a,s));return}}w(!1)},[o,k,w,C,J]),G=(0,s.useCallback)(e=>{if(!(null==T?void 0:T.current))return;let t=T.current.selectionStart,n=r.slice(0,t),s=r.slice(t),o=n.lastIndexOf("@");-1!==o&&(x(r.slice(0,o)+"@".concat(e.name," ")+s),w(!1),setTimeout(()=>{if(T.current){let t=o+e.name.length+2;T.current.focus(),T.current.setSelectionRange(t,t)}},0))},[r,x,w,T]),Q=(0,s.useCallback)(e=>{if(h){let t=y(R),r=t.length;switch(e.key){case"ArrowDown":e.preventDefault(),C(e=>e<r-1?e+1:0);break;case"ArrowUp":e.preventDefault(),C(e=>e>0?e-1:r-1);break;case"Tab":case"Enter":e.preventDefault(),r>0&&G(t[v]);break;case"Escape":e.preventDefault(),w(!1);break;default:return}}else if("Enter"!==e.key||e.shiftKey)"Escape"===e.key&&p&&j(!1);else{if(e.preventDefault(),e.nativeEvent.isComposing)return;(r.trim()||L.length>0)&&$(e)}},[r,L,h,p,v,y,G,$,C,w,j,R]),ee=(0,s.useCallback)(e=>{let t,n,s,o;if(!(null==T?void 0:T.current))return;let a=T.current,l=a.selectionStart,i=a.selectionEnd,c=r.substring(l,i);e.includes("\n")?(t=r.substring(0,l)+e.replace("\n\n","\n"+c+"\n")+r.substring(i),c?n=o=(s=l+e.split("\n")[0].length+1)+c.length:(s=n=l+e.indexOf("\n")+1,o=n)):e.endsWith(" ")?(t=r.substring(0,l)+e+c+r.substring(i),s=n=l+e.length+c.length,o=n):c?(t=r.substring(0,l)+e+c+e+r.substring(i),n=o=(s=l+e.length)+c.length):(t=r.substring(0,l)+e+r.substring(i),s=n=l+e.length,o=n),x(t),setTimeout(()=>{T.current&&(a.focus(),a.setSelectionRange(s,o))},0)},[r,x,T]),et=(0,s.useCallback)(e=>{if(!(null==T?void 0:T.current))return;let t=T.current.selectionStart||r.length;x(r.slice(0,t)+e.native+r.slice(t)),j(!1),setTimeout(()=>{if(T.current){let r=t+e.native.length;T.current.focus(),T.current.setSelectionRange(r,r)}},0)},[r,x,j,T]),er=(0,s.useCallback)(()=>{j(e=>!e)},[j]),en=u||U||m;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"chat-input-wrapper ".concat(B?"dragging":""),ref:E,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),O(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),O(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),O(!0)},onDrop:X,children:(0,n.jsxs)("div",{className:"chat-input",children:[L.length>0&&(0,n.jsx)(ep,{files:L,uploading:U,uploadProgress:z,uploadError:P,onRemove:Y,onRetry:()=>_(null),showFileName:!0,showFileSize:!0,variant:"default"}),(0,n.jsx)("div",{className:"chat-input-toolbar",children:(0,n.jsx)(ed,{onAction:ee,size:"md"})}),(0,n.jsxs)("div",{className:"chat-input-main",style:{position:"relative"},children:[(0,n.jsx)("textarea",{ref:T,value:r,onChange:V,onKeyDown:Q,placeholder:B?"파일을 여기에 놓아주세요.":"메시지를 입력하세요... (@를 입력하여 멘션, Shift + Enter로 줄바꿈)",disabled:en,rows:1,autoComplete:"off",spellCheck:"true",className:"chat-input-textarea",style:{minHeight:"40px",maxHeight:"".concat(15*parseFloat(getComputedStyle(document.documentElement).fontSize),"px"),resize:"none",width:"100%",border:"1px solid var(--vapor-color-border)",borderRadius:"var(--vapor-radius-md)",padding:"var(--vapor-space-150)",paddingRight:"120px",backgroundColor:"var(--vapor-color-normal)",color:"var(--vapor-color-text-primary)",fontSize:"var(--vapor-font-size-100)",lineHeight:"1.5",transition:"all 0.2s ease"}}),(0,n.jsxs)(d.z,{color:"primary",size:"md",onClick:$,disabled:en||!r.trim()&&0===L.length,"aria-label":"메시지 보내기",style:{position:"absolute",bottom:"8px",right:"8px",padding:"8px 16px"},children:[(0,n.jsx)(A.jE$,{size:20}),(0,n.jsx)("span",{style:{marginLeft:"var(--vapor-space-100)"},children:"보내기"})]})]}),(0,n.jsxs)("div",{className:"chat-input-actions",children:[p&&(0,n.jsx)("div",{ref:S,className:"emoji-picker-wrapper",onClick:e=>e.stopPropagation(),children:(0,n.jsx)("div",{className:"emoji-picker-container",children:(0,n.jsx)(K,{onSelect:et,emojiSize:20,emojiButtonSize:36,perLine:8,maxFrequentRows:4})})}),(0,n.jsxs)(g.Ug,{gap:"100",children:[(0,n.jsx)(Z.h,{ref:N,variant:"ghost",size:"md",onClick:er,disabled:en,"aria-label":"이모티콘",style:{transition:"all 0.2s ease"},onMouseEnter:e=>e.currentTarget.style.transform="translateY(-2px)",onMouseLeave:e=>e.currentTarget.style.transform="translateY(0)",children:(0,n.jsx)(A.lME,{size:20})}),(0,n.jsx)(Z.h,{variant:"ghost",size:"md",onClick:()=>{var e;return null==c?void 0:null===(e=c.current)||void 0===e?void 0:e.click()},disabled:en,"aria-label":"파일 첨부",style:{transition:"all 0.2s ease"},onMouseEnter:e=>e.currentTarget.style.transform="translateY(-2px)",onMouseLeave:e=>e.currentTarget.style.transform="translateY(0)",children:(0,n.jsx)(A.Cb4,{size:20})}),(0,n.jsx)("input",{type:"file",ref:c,onChange:e=>{var t;return H(null===(t=e.target.files)||void 0===t?void 0:t[0])},style:{display:"none"},accept:"image/*,video/*,audio/*,application/pdf"})]})]})]})}),h&&(0,n.jsx)("div",{style:{position:"fixed",top:"".concat(q.top,"px"),left:"".concat(q.left,"px"),zIndex:9999},children:(0,n.jsx)(em,{participants:y(R),activeIndex:v,onSelect:G,onMouseEnter:e=>C(e)})})]})});eh.displayName="ChatInput";let ef=(0,p.Q)(()=>{let{room:e,messages:t,streamingMessages:r,connected:s,connectionStatus:p,messageLoadError:h,retryMessageLoad:f,currentUser:v,message:y,showEmojiPicker:x,showMentionList:j,mentionFilter:w,mentionIndex:b,filePreview:k,fileInputRef:C,messageInputRef:R,messagesEndRef:S,socketRef:N,handleMessageChange:E,handleMessageSubmit:I,handleEmojiToggle:T,setMessage:M,setShowEmojiPicker:A,setShowMentionList:U,setMentionFilter:F,setMentionIndex:z,handleKeyDown:D,removeFilePreview:P,getFilteredParticipants:_,insertMention:B,loading:O,error:q,handleReactionAdd:Z,handleReactionRemove:W,loadingMessages:H,hasMoreMessages:K,handleLoadMore:Y}=L();if(O||!e)return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsx)(c.Zb.Root,{className:"chat-room-card",children:(0,n.jsx)(c.Zb.Body,{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:(0,n.jsxs)(g.xu,{style:{textAlign:"center",marginTop:"var(--vapor-space-500)"},children:[(0,n.jsx)("div",{className:"spinner-border mb-4",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("br",{}),(0,n.jsx)(i.x,{typography:"heading5",children:"채팅방 연결 중..."})]})})})});if(q)return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsx)(c.Zb.Root,{className:"chat-room-card",children:(0,n.jsxs)(c.Zb.Body,{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[(0,n.jsx)(g.xu,{style:{marginBottom:"var(--vapor-space-400)"},children:(0,n.jsx)(u.U,{color:"danger",children:(0,n.jsxs)(g.kC,{align:"center",gap:"200",children:[(0,n.jsx)(o.Z,{className:"w-5 h-5"}),(0,n.jsx)(i.x,{children:q||"채팅방을 불러오는데 실패했습니다."})]})})}),(0,n.jsx)(d.z,{onClick:()=>window.location.reload(),children:"다시 시도"})]})})});let X="connecting"===p?{label:"연결 중...",color:"warning"}:"connected"===p?{label:"연결됨",color:"success"}:{label:"연결 끊김",color:"danger"};return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsxs)(c.Zb.Root,{className:"chat-room-card",children:[(0,n.jsx)(c.Zb.Header,{className:"chat-room-header",children:(0,n.jsxs)(g.kC,{justify:"space-between",align:"center",children:[(0,n.jsxs)(g.kC,{align:"center",gap:"300",children:[(0,n.jsx)(i.x,{typography:"heading4",style:{fontWeight:"bold"},className:"chat-room-title",children:e.name}),(()=>{if(!(null==e?void 0:e.participants))return null;let t=e.participants,r=Math.max(0,t.length-3);return(0,n.jsxs)(g.Ug,{gap:"100",align:"center",children:[t.slice(0,3).map(e=>{let t=(0,ee.FV)(e.email),r=(0,ee.pJ)(t);return(0,n.jsx)(l.qE.Root,{size:"md",style:{backgroundColor:t,color:r,flexShrink:0},children:(0,n.jsx)(l.qE.Fallback,{style:{backgroundColor:t,color:r},children:e.name.charAt(0).toUpperCase()})},e._id)}),r>0&&(0,n.jsx)(l.qE.Root,{size:"md",style:{backgroundColor:"var(--vapor-color-secondary)",color:"white",flexShrink:0},children:(0,n.jsxs)(l.qE.Fallback,{style:{backgroundColor:"var(--vapor-color-secondary)",color:"white"},children:["+",r]})}),(0,n.jsxs)(i.x,{typography:"body2",className:"ms-3",children:["총 ",t.length,"명"]})]})})()]}),(0,n.jsx)(m.C,{color:"success"===X.color?"success":"warning"===X.color?"warning":"danger",children:X.label})]})}),(0,n.jsx)(c.Zb.Body,{className:"chat-room-body",children:(0,n.jsx)("div",{className:"chat-messages",children:O?(0,n.jsxs)("div",{className:"d-flex align-items-center justify-content-center p-4",children:[(0,n.jsx)("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("span",{children:"채팅방 연결 중..."})]}):q?(0,n.jsxs)("div",{className:"d-flex flex-column align-items-center justify-content-center p-4",children:[(0,n.jsxs)(u.U,{color:"danger",className:"mb-4 d-flex align-items-center",children:[(0,n.jsx)(o.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:q})]}),(0,n.jsx)(d.z,{onClick:()=>window.location.reload(),children:"다시 시도"})]}):"disconnected"===p?(0,n.jsx)(g.xu,{style:{margin:"var(--vapor-space-400)"},children:(0,n.jsxs)(u.U,{color:"warning",className:"d-flex align-items-center",children:[(0,n.jsx)(a.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:"연결이 끊어졌습니다. 재연결을 시도합니다..."})]})}):h?(0,n.jsxs)("div",{className:"d-flex flex-column align-items-center justify-content-center p-4",children:[(0,n.jsxs)(u.U,{color:"danger",className:"mb-4 d-flex align-items-center",children:[(0,n.jsx)(o.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:"메시지 로딩 중 오류가 발생했습니다."})]}),(0,n.jsx)(d.z,{onClick:f,children:"메시지 다시 로드"})]}):(0,n.jsx)(eu,{messages:t,streamingMessages:r,currentUser:v,room:e,messagesEndRef:S,onReactionAdd:Z,onReactionRemove:W,loadingMessages:H,hasMoreMessages:K,onLoadMore:Y,socketRef:N})})}),(0,n.jsx)(c.Zb.Footer,{className:"chat-room-footer",children:(0,n.jsx)(eh,{message:y,onMessageChange:E,onSubmit:I,onEmojiToggle:T,fileInputRef:C,messageInputRef:R,filePreview:k,disabled:"connected"!==p,uploading:!1,showEmojiPicker:x,showMentionList:j,mentionFilter:w,mentionIndex:b,getFilteredParticipants:_,setMessage:M,setShowEmojiPicker:A,setShowMentionList:U,setMentionFilter:F,setMentionIndex:z,room:e,onMentionSelect:e=>{B(e),U(!1)},onFileRemove:P})})]})})})}},e=>{var t=t=>e(e.s=t);e.O(0,[834,658,314,510,262,888,774,179],()=>t(17722)),_N_E=e.O()}]);